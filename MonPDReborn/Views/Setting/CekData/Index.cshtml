@model MonPDReborn.Models.Setting.CekDataVM.Index

@{
    ViewData["Title"] = "Cek Data";
    Layout = "_Layout";
}

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header d-flex bg-header-color align-items-center">
                <div class="flex-grow-1">
                    <h4 class="card-title text-dark fs-16 mb-1">
                        Data Realisasi VS Scontro
                    </h4>
                </div>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="dropdown">
                        <select id="ddlTahun" class="form-select form-select mb-3 w-auto"
                                style="background-color: #f0f8ff; color: #333; border-color: #0d6efd;">
                            <!-- Tahun akan diisi dengan JavaScript -->
                        </select>
                    </div>
                </div>

                <div class="text-center">
                    <div id="loading2-Show" class="spinner-border text-primary" style="display: none">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>

                <div id="Show"></div>

            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script type="text/javascript">
        $(document).ready(function () {
            // Inisialisasi dropdown tahun
            var currentYear = new Date().getFullYear();
            for (var year = currentYear; year >= 2021; year--) {
                $('#ddlTahun').append($('<option>', {
                    value: year,
                    text: year
                }));
            }
            // Set tahun awal ke tahun saat ini
            $('#ddlTahun').val(currentYear);
            // Load data saat halaman pertama kali dimuat
            loadRekapData(currentYear);
            // Event handler untuk perubahan tahun
            $('#ddlTahun').change(function () {
                var selectedYear = $(this).val();
                loadRekapData(selectedYear);
            });
        });
        function loadRekapData(tahun) {
            $('#loading2-Show').show();
            $('#Show').hide();
            $.ajax({
                url: '@Url.Action("Show", "CekData")',
                type: 'GET',
                data: { tahun: tahun },
                success: function (result) {
                    $('#Show').html(result);
                    $('#loading2-Show').hide();
                    $('#Show').show();
                },
                error: function (xhr, status, error) {
                    console.error('Error loading data:', error);
                    $('#loading2-Show').hide();
                    $('#Show').html('<div class="alert alert-danger">Error loading data.</div>');
                    $('#Show').show();
                }
            });
        }
    </script>
    <script>
                   // Fungsi bantu untuk parse angka (hilangkan titik/koma pemisah ribuan)
        function parseNumber(val) {
            if (val == null) return 0;
            return Number(String(val).replace(/\./g, "").replace(/,/g, ""));
        }

        // Dipanggil saat cell di grid kiri (dataRealisasiGrid) di-render
        function onRealisasiCellPrepared(e) {
            if (e.rowType === "data" && e.column.dataField === "realisasi") {
                let scontroGrid = $("#dataScontroGrid").dxDataGrid("instance");
                if (!scontroGrid) return;

                let scontroData = scontroGrid.getDataSource().items();

                // cari data yang cocok berdasarkan jenisPajak
                let match = scontroData.find(x =>
                    String(x.jenisPajak).trim().toLowerCase() === String(e.data.jenisPajak).trim().toLowerCase()
                );

                let valRealisasi = parseNumber(e.data.realisasi);
                let valScontro = match ? parseNumber(match.scontro) : null;

                // debug di console
                console.log("COMPARE =>", e.data.jenisPajak, valRealisasi, valScontro);

                if (valScontro !== null) {
                    if (valRealisasi === valScontro) {
                        // sama → hijau
                        e.cellElement.css({
                            "background-color": "#ccffcc",
                            "color": "green",
                            "font-weight": "bold"
                        });
                    } else if (valRealisasi < valScontro) {
                        // lebih kecil → merah
                        e.cellElement.css({
                            "background-color": "#ffcccc",
                            "color": "red",
                            "font-weight": "bold"
                        });
                    }
                    // lebih besar → tidak diberi warna (default)
                }
            }
        }

        // Dipanggil ketika grid kanan (dataScontroGrid) selesai load
        function onScontroReady(e) {
            console.log("Data Scontro Loaded:", e.component.getDataSource().items());
            // refresh grid kiri supaya event onCellPrepared jalan lagi dengan data baru
            $("#dataRealisasiGrid").dxDataGrid("instance").refresh();
        }

    </script>


}