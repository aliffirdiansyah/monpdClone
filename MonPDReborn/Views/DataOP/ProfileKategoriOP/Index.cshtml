@model MonPDReborn.Models.DataOP.ProfileKategoriOPVM.Index

@{
    Layout = "_Layout";
    ViewBag.Title = "Profile Kategori Objek Pajak";
}

<div class="row">

    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <div class="flex-grow-1">
                    <h4 class="card-title text-dark fs-16 mb-0">
                        Detail Objek per Kategori
                    </h4>
                </div>
            </div>
            <div class="car-body">
                <div class="row mt-3 ms-0">

                    <div class="col-lg-3">
                        @(Html.DevExtreme().SelectBox()
                            .ID("SelectedPajak")
                            .Value(Model.SelectedPajak.ToString())
                            .DataSource(Model.JenisPajakList)
                            .Placeholder("Pilih Jenis Pajak..")
                            .DisplayExpr("Text")
                            .ValueExpr("Value")
                            .SearchEnabled(true)
                            .StylingMode(EditorStylingMode.Outlined)
                            .ElementAttr("class", "mb-3")
                            )
                    </div>

                    <div class="col-lg-2">
                        <button type="button" class="btn btn-success w-80">
                            <i class="bi bi-funnel-fill me-1"></i> Terapkan Filter
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <div class="text-center">
                    <div id="loading2-Show" class="spinner-border text-primary" style="display: none">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="Show"></div>
            </div>
        </div>
    </div>

</div>

@section Scripts{
    <script>
        $(document).ready(function () {
                fnShow();
            $('.btn-success').on('click', function () {
                fnShow();
            });
        });

        function getFilters() {
            return {
                jenisPajak: $("#SelectedPajak").dxSelectBox("instance").option("value"),
            };
        }

        function fnShow() {
            const filters = getFilters();
            
            $.ajax({
                url: '@(Url.Action("Show"))',
                type: 'GET',
                data: {
                    jenisPajak: filters.jenisPajak,
                },
                beforeSend: function () {
                    $('#loading2-Show').show();
                    $('#Show').hide();
                },
                success: function (response) {
                    $('#loading2-Show').hide();
                    $('#Show').show().html(response);
                },
                error: function (xhr) {
                    $('#loading2-Show').hide();
                    $('#Show').html('<p class="text-danger">Terjadi kesalahan saat memuat data.</p>');
                }
            });
        }

        function onDetailClick(e) {
            e.event.preventDefault();

            const rowData = e.row?.data;

            if (!rowData) {
                DevExpress.ui.notify("Data tidak ditemukan", "error", 2000);
                return;
            }

            // Ambil data dari row
            const jenisPajak = rowData.EnumPajak;      // sudah ada di data row
            const kategoriId = rowData.KategoriId;     // pastikan kolom ini ada di data grid

            console.log("Detail click:", jenisPajak, kategoriId);

            const $modal = $("#staticBackdropFullScreenScrollable");
            $modal.find(".modal-title").text(`Detail Penanggung Jawab`);
            $modal.find(".modal-body").html(`
                <div class="text-center my-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `);
            $modal.modal("show");

            $.ajax({
                url: '/ProfileKategoriOP/DetailKategoriProfile',
                type: 'GET',
                data: {
                    jenisPajak: jenisPajak,
                    kategoriId: kategoriId
                },
                success: function (response) {
                    $modal.find(".modal-body").html(response);
                },
                error: function () {
                    $modal.find(".modal-body").html(`
                        <div class="alert alert-danger">
                            Gagal memuat detail data.
                        </div>
                    `);
                }
            });
        }

        function onDetailKategoriClick(e) {
            e.event.preventDefault();

            const rowData = e.row?.data;
            if (!rowData) {
                DevExpress.ui.notify("Data tidak ditemukan", "error", 2000);
                return;
            }

            const jenisPajak = rowData.EnumPajak;
            const kategoriId = rowData.KategoriId;
            const nip = rowData.Nip;



            const $modalLarge = $("#staticBackdropExtraLargeScrollable");
            const $modalFull = $("#staticBackdropFullScreenScrollable");

            $modalLarge.find(".modal-title").text(`Detail Kategori - ${jenisPajak}`);
            $modalLarge.find(".modal-body").html(`
                <div class="text-center my-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            `);

            // Saat modal kecil akan dibuka
            $modalLarge.off('show.bs.modal').on('show.bs.modal', function () {
                $(this).css("z-index", 1070);
                $(".modal-backdrop").last().css("z-index", 1060);
            });

            // Saat modal kecil ditutup → pulihkan modal fullscreen
            $modalLarge.off('hidden.bs.modal').on('hidden.bs.modal', function () {
                if ($modalFull.is(':visible')) {
                    $modalFull.css("z-index", 1055);
                    $(".modal-backdrop").last().css("z-index", 1050);
                }
            });

                var bsModal = new bootstrap.Modal(document.getElementById('staticBackdropExtraLargeScrollable'), {
                backdrop: 'static',
                keyboard: false
            });
            bsModal.show();

            $.ajax({
                url: '/ProfileKategoriOP/DetailKategoriProfileOP',
                type: 'GET',
                data: {
                    jenisPajak: jenisPajak,
                    kategoriId: kategoriId,
                    nip: nip
                },
                success: function (response) {
                    $modalLarge.find(".modal-body").html(response);
                },
                error: function () {
                    $modalLarge.find(".modal-body").html(`
                        <div class="alert alert-danger">
                            Gagal memuat detail data.
                        </div>
                    `);
                }
            });
        }

        function onDetailOPClick(e) {
            e.event.preventDefault();

            const rowData = e.row?.data;
            if (!rowData) {
                DevExpress.ui.notify("Data tidak ditemukan", "error", 2000);
                return;
            }

            // Ambil parameter dari row
            const nop = rowData.Nop;
            const pajak = rowData.EnumPajak; // pastikan field ini sesuai dengan model kamu

            if (!nop || pajak === undefined) {
                DevExpress.ui.notify("Parameter tidak lengkap", "error", 2000);
                return;
            }

            // Buat URL tujuan
            const url = `/ProfileOP/Detail?nop=${encodeURIComponent(nop)}&pajak=${pajak}`;

            // Buka di tab baru
            window.open(url, '_blank');
        }

        function onPotensiOPClick(e) {
            e.event.preventDefault();

            const rowData = e.row?.data;
            if (!rowData) {
                DevExpress.ui.notify("Data tidak ditemukan", "error", 2000);
                return;
            }

            // Ambil parameter dari row
            const nop = rowData.Nop;
            const jenisPajak = rowData.EnumPajak;
            const kategori = rowData.KategoriId; // pastikan sesuai property di model

            if (!nop || jenisPajak === undefined || kategori === undefined) {
                DevExpress.ui.notify("Parameter tidak lengkap", "error", 2000);
                return;
            }

            // Buat URL tujuan
            const url = `/ProfilePotensiOP/DetailPotensiOP?nop=${encodeURIComponent(nop)}&jenisPajak=${jenisPajak}&kategori=${kategori}`;

            // Buka di tab baru
            window.open(url, '_blank');
        }


    </script>
}