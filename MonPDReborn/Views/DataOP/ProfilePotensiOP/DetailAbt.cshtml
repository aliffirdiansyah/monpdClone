@model MonPDReborn.Models.DataOP.ProfilePotensiOPVM.DetailPotensiPajakABT
@{
    ViewBag.Title = "Detail Potensi Pajak Air Tanah";

}
@if (Model != null)
{
    <div class="row">

        <div class="col-lg-12">
            <div class="card border border-primary border-2">
                <div class="card-body">
                    <div class="row">

                        <div class="col-lg-8">
                            <div class="d-flex p-3">
                                <div class="flex-shrink-0">
                                    <div class="avatar-md me-3">
                                        <span class="avatar-title bg-soft-primary rounded-circle fs-1">
                                            <i class="mdi mdi-water text-primary"></i>
                                        </span>
                                    </div>
                                </div>
                                <div class="mt-2">
                                    <h4 class="fs-16 fw-semibold">
                                        @Model.Nama
                                    </h4>
                                    <p class="fs-16 lh-base">
                                        NOP : @Model.FormattedNOP
                                    </p>
                                    <p class="fs-16 lh-base">
                                        ALAMAT : @Model.Alamat
                                    </p>
                                    <p class="fs-16 lh-base">
                                        Kelompok : @Model.KelompokNama
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="col-lg-4">
                            <div class="card border border-2 border-primary h-100 d-flex flex-column justify-content-between">
                                <div class="p-3 text-center">
                                    <h3 class="fs-16 fw-semibold text-dark mb-3">Detail Realisasi</h3>
                                    <p class="fs-14 text-muted mb-4">Lihat detail realisasi pajak objek ini</p>
                                    <button class="btn btn-light w-100"
                                            onclick="window.open('/ProfileOP/Detail?nop=@Model.NOP&pajak=1', '_blank')">
                                        <i class="ri-bar-chart-line me-1"></i> Realisasi
                                    </button>
                                </div>
                            </div>
                        </div>

                        @* <div class="col-lg-4">
                        <div class="card border border-primary border-2">
                            <div class="d-flex p-3">
                                <h3 class="fs-16 fw-semibold">Status : </h3>
                            </div>
                            <div class="d-flex p-3">
                                <h3 class="fs-16 fw-semibold">Periode : </h3>
                            </div>
                        </div>
                    </div> *@

                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-6">
            <div class="card bg-soft-primary">
                <div class="card-body">
                    <h4 class="fs-14">RATA-RATA VOLUME PENGGUNAAN</h4>
                    <h3 class="fs-18 fw-semibold mb-1">@Model.VolumeRata.ToString("N0") M³</h3>
                    <h4 class="fs-14">Volume air bawah tanah yang digunakan</h4>
                </div>
            </div>
        </div>

        @{
            var total = Model.PajakAir * 12;
        }

        <div class="col-lg-6">
            <div class="card bg-soft-primary">
                <div class="card-body">
                    <h4 class="fs-14">TOTAL POTENSI AIR BAWAH TANAH</h4>
                    <h3 class="fs-18 fw-semibold mb-1">Rp. @total.ToString("N0") / 1 tahun</h3>
                    <h4 class="fs-14">Berdasarkan volumen dan tarif yang berlaku</h4>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header d-flex bg-header-color align-items-center">
                    <div class="flex-grow-1">
                        <h4 class="card-title text-black fs-16 mb-0">
                            Detail Volume Penggunaan
                        </h4>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">

                        <div class="col-lg-12">
                            <div class="card-body">
                                <div class="d-flex p-3 py-0">
                                    <p class="fs-14 text-muted flex-grow-1">Volume Rata-Rata</p>
                                    <div class="flex-shrink-0">
                                        <p class="fs-16 fw-semibold">@Model.VolumeRata.ToString("N0") M³</p>
                                    </div>
                                </div>
                                @{
                                    var detail = Model.DetailPerhitungan; // List<DetailPerhitunganABT>
                                    var totalVolume = detail.Sum(x => x.Volume);
                                    var colors = new[] { "bg-primary", "bg-info", "bg-warning", "bg-danger", "bg-success" };
                                }
                                <div class="col-lg-12">
                                    <div class="card-body">
                                        <!-- DETAIL PER RANGE -->
                                        @for (int i = 0; i < detail.Count; i++)
                                        {
                                            var item = detail[i];
                                            var color = colors[i % colors.Length];
                                            <div class="d-flex p-3 py-0">
                                                <p class="fs-14 text-muted flex-grow-1">
                                                    Range @(i + 1)
                                                    (@item.BatasMinim.ToString("n0") -
                                                    @(item.BatasMaks == 9999 ? "∞" : item.BatasMaks.ToString("n0")) m³)
                                                </p>
                                                <div class="flex-shrink-0">
                                                    <p class="fs-16 fw-semibold">@item.Volume.ToString("n0") m³</p>
                                                </div>
                                            </div>
                                            <div class="progress" style="height:20px">
                                                <div class="progress-bar progress-bar-striped progress-bar-animated text-white @color"
                                                     role="progressbar"
                                                     style="width: 100%"
                                                     aria-valuenow="100"
                                                     aria-valuemin="0"
                                                     aria-valuemax="100">
                                                </div>
                                            </div>
                                        }
                                        <hr />
                                        <!-- DISTRIBUSI VOLUME (STACKED PROGRESS BAR) -->
                                        <div class="flex-grow-1 mb-2">
                                            <h4 class="card-title text-black fs-16 mb-0">Distribusi Volume</h4>
                                        </div>
                                        <div class="progress" style="height: 20px">
                                            @for (int i = 0; i < detail.Count; i++)
                                            {
                                                var item = detail[i];
                                                var percent = totalVolume > 0 ? (item.Volume / totalVolume * 100m) : 0;
                                                var color = colors[i % colors.Length];
                                                <div class="progress-bar progress-bar-striped progress-bar-animated text-white @color"
                                                     role="progressbar"
                                                     style="width: @percent.ToString("n0")%"
                                                     title="Range @(i + 1): @item.Volume.ToString("n0") m³"
                                                     aria-valuenow="@percent.ToString("n0")"
                                                     aria-valuemin="0"
                                                     aria-valuemax="100">
                                                </div>
                                            }
                                        </div>
                                        <small class="text-dark-50">Visualisasi distribusi volume penggunaan berdasarkan range</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @* <div class="col-lg-12">
                        <div class="card-body">
                            <div class="flex-grow-1">
                                <h4 class="card-title text-black fs-16 mb-0">
                                    Distribusi Volume
                                </h4>
                            </div>
                            <div class="progress" style="height:20px">
                                <div class="progress-bar progress-bar-striped progress-bar-animated text-white" role="progressbar" style="width: 73%" aria-valuenow="73" aria-valuemin="0" aria-valuemax="100"></div>
                                <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" role="progressbar" style="width: 27%" aria-valuenow="27" aria-valuemin="0" aria-valuemax="100"></div>
                            </div>
                            <small class="text-dark-50">Visualisasi distribusi volume penggunaan berdasarkan range</small>
                        </div>
                    </div> *@

                    </div>

                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header d-flex bg-header-color align-items-center">
                    <div class="flex-grow-1">
                        <h4 class="card-title text-black fs-16 mb-0">Detail Harga Dasar Air</h4>
                    </div>
                </div>
                <div class="card-body">
                    @for (int i = 0; i < detail.Count; i++)
                    {
                        var item = detail[i];
                        <div class="d-flex p-3 py-0">
                            <p class="fs-14 text-muted flex-grow-1">Range @(i + 1)</p>
                            <div class="flex-shrink-0">
                                <p class="fs-16 fw-semibold">Rp @item.HDA.ToString("n2")</p>
                            </div>
                        </div>
                        @if (i != detail.Count - 1)
                        {
                            <hr />
                        }
                    }

                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card mt-2">
                                <div class="card-body py-2">
                                    <small class="text-dark-50">HDA = Harga Dasar Air yang ditetapkan berdasarkan range volume penggunaan</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        @{

            var tarif = Model.TarifPajakPersen;
        }

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header d-flex bg-header-color align-items-center">
                    <div class="flex-grow-1">
                        <h4 class="card-title text-black fs-16 mb-0">Nilai Perolehan Air (NPA)</h4>
                    </div>
                </div>
                <div class="card-body">
                    @for (int i = 0; i < detail.Count; i++)
                    {
                        var item = detail[i];
                        var npa = item.Volume * item.HDA;
                        <div class="d-flex p-3 py-0">
                            <p class="fs-14 text-muted flex-grow-1">NPA Range @(i + 1)</p>
                            <div class="flex-shrink-0">
                                <p class="fs-16 fw-semibold">Rp @npa.ToString("n0")</p>
                            </div>
                        </div>
                        @if (i != detail.Count - 1)
                        {
                            <hr />
                        }
                    }

                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card mt-2">
                                <div class="card-body py-2">
                                    <div class="d-flex p-3 py-0">
                                        <p class="fs-14 text-muted flex-grow-1">Total NPA</p>
                                        <div class="flex-shrink-0">
                                            <p class="fs-16 fw-semibold">Rp @Model.TotalNPA.ToString("n0")</p>
                                        </div>
                                    </div>
                                    <div class="d-flex p-3 py-0">
                                        <p class="fs-14 text-muted flex-grow-1">Pajak Air (@tarif.ToString("n0")%)</p>
                                        <div class="flex-shrink-0">
                                            <p class="fs-16 fw-semibold">Rp @Model.PajakAir.ToString("n0")</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        @* <div class="col-lg-6">
        <div class="card">
            <div class="card-header d-flex bg-header-color align-items-center">
                <div class="flex-grow-1">
                    <h4 class="card-title text-black fs-16 mb-0">
                        Distribusi Volume per Range
                    </h4>
                </div>
            </div>
            <div class="card-body">
                <div id="simple_pie_chart" data-colors='["--vz-primary", "--vz-success", "--vz-warning", "--vz-danger", "--vz-info"]' class="apex-charts" dir="ltr"></div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header d-flex bg-header-color align-items-center">
                <div class="flex-grow-1">
                    <h4 class="card-title text-black fs-16 mb-0">
                        Kontribusi NPA per Range
                    </h4>
                </div>
            </div>
            <div class="card-body">
                <div id="column_chart" data-colors='["--vz-danger", "--vz-primary", "--vz-success"]' class="apex-charts" dir="ltr"></div>
            </div>
        </div>
    </div>
 *@
        <div class="col-lg-12">
            <div class="card">
                <div class="card-header d-flex bg-header-color align-items-center">
                    <div class="flex-grow-1">
                        <h4 class="card-title text-black fs-16 mb-0">
                            Parameter Perhitungan
                        </h4>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">

                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-body">
                                    <div class="flex-grow-1">
                                        <h4 class="card-title text-black fs-16 mb-0">
                                            Rumus Perhitungan
                                        </h4>
                                    </div>
                                    <hr />
                                    <h4 class="fs-14">NPA Range 1 : Volume R1 × HDA R1</h4>
                                    <h4 class="fs-14">NPA Range 2 : Volume R2 × HDA R2</h4>
                                    <h4 class="fs-14">NPA Range 3 : Volume R3 × HDA R3</h4>
                                    <h4 class="fs-14">NPA Range 4 : Volume R4 × HDA R4</h4>
                                    <h4 class="fs-14">NPA Range 5 : Volume R5 × HDA R5</h4>
                                    <hr />
                                    <h4 class="fs-14">Total NPA = NPA R1 + NPA R2 + NPA R3 + NPA R4 + NPA R5</h4>
                                    <h4 class="fs-14">Potensi ABT = Total NPA × 20%</h4>
                                    <h4 class="fs-14">Potensi ABT = Rp <span class="text-primary fw-bold">@Model.PajakAir.ToString("n0")</span></h4>
                                </div>
                            </div>
                        </div>

                        @* 
                    <div class="col-lg-4">
                        <div class="card">
                            <div class="card-body">
                                <div class="flex-grow-1">
                                    <h4 class="card-title text-black fs-16 mb-0">
                                        Distribusi Volume
                                    </h4>
                                </div>
                                <h4 class="fs-14">Range 1 :</h4>
                                <h4 class="fs-14">Range 2 :</h4>
                                <h4 class="fs-14">Range 3 :</h4>
                                <h4 class="fs-14">Range 4 :</h4>
                                <h4 class="fs-14">Range 5 :</h4>
                            </div>
                        </div>
                    </div>

 *@

                    </div>
                </div>
            </div>
        </div>

    </div>
}
else
{
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-md-6 col-12">
                <div class="card text-center shadow-sm border-0">
                    <div class="card-body">
                        <img src="~/assets/images/coming-soon-img.png" alt="Tidak Ada Data" class="img-fluid mb-4" style="max-width: 180px;" />
                        <h5 class="card-title text-danger">Data Tidak Ditemukan</h5>
                        <p class="card-text text-muted">
                            Maaf, data yang Anda cari belum tersedia atau tidak ditemukan.
                            @* Coba ubah filter atau periksa kembali input Anda. *@
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
}


@section Scripts {
    <script>
        function renderSimplePieChart() {
            const chartEl = document.querySelector("#simple_pie_chart");
            const colors = JSON.parse(chartEl.getAttribute("data-colors")).map(function(value) {
                const newValue = value.replace("--", "");
                return getComputedStyle(document.documentElement).getPropertyValue(`--${newValue}`).trim() || value;
            });

            const options = {
                chart: {
                    type: 'pie',
                    height: 320
                },
                series: [44, 33, 54, 12, 20], // Ubah sesuai data Anda
                labels: ['Produk A', 'Produk B', 'Produk C', 'Produk D', 'Produk E'],
                colors: colors,
                legend: {
                    position: 'bottom'
                }
            };

            const chart = new ApexCharts(chartEl, options);
            chart.render();
        }

        // Panggil fungsi saat halaman dimuat
        document.addEventListener("DOMContentLoaded", renderSimplePieChart);
    </script>
    <script>
        function renderColumnChart() {
            const chartEl = document.querySelector("#column_chart");
            const colors = JSON.parse(chartEl.getAttribute("data-colors")).map(function(value) {
                const cssVar = value.replace("--", "");
                return getComputedStyle(document.documentElement).getPropertyValue(`--${cssVar}`).trim() || value;
            });

            const options = {
                chart: {
                    type: 'bar',
                    height: 350
                },
                plotOptions: {
                    bar: {
                        horizontal: false,
                        columnWidth: '45%',
                        endingShape: 'rounded'
                    },
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    show: true,
                    width: 2,
                    colors: ['transparent']
                },
                series: [
                    {
                        name: 'Produk A',
                        data: [44, 55, 41, 67, 22, 43, 21]
                    },
                    {
                        name: 'Produk B',
                        data: [13, 23, 20, 8, 13, 27, 33]
                    },
                    {
                        name: 'Produk C',
                        data: [11, 17, 15, 15, 21, 14, 15]
                    }
                ],
                colors: colors,
                xaxis: {
                    categories: ['Sen', 'Sel', 'Rab', 'Kam', 'Jum', 'Sab', 'Min']
                },
                fill: {
                    opacity: 1
                },
                tooltip: {
                    y: {
                        formatter: function (val) {
                            return val + " unit";
                        }
                    }
                },
                legend: {
                    position: 'top'
                }
            };

            const chart = new ApexCharts(chartEl, options);
            chart.render();
        }

        // Jalankan saat halaman dimuat
        document.addEventListener("DOMContentLoaded", renderColumnChart);
    </script>
}