@using MonPDLib.General
@using System.Globalization
@model MonPDReborn.Models.DataOP.ProfileOPVM.Detail
@{
    var pembayaran = (MonPDReborn.Models.DataOP.ProfilePembayaranOPVM.Detail)ViewBag.DetailPembayaran;
}

@{
    var currentYear = DateTime.Now.Year;
    var tahunMin1 = (currentYear - 1).ToString();
    var tahunNow = currentYear.ToString();
}
@* <style>
    /* Background */
    .header-bg {
        background: linear-gradient(135deg, #00b894, #00cec9);
        position: relative;
    }

/* Center logo */
.logo-center {
    width: 100px;
    height: 100px;
    object-fit: contain;
    z-index: 2;
}

/* Particles */
.particle {
    position: absolute;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.3);
    animation: floatParticle 8s infinite ease-in-out;
}

/* Variasi ukuran, posisi, dan kecepatan */
.particle:nth-child(1) { width: 20px; height: 20px; top: 10%; left: 15%; animation-duration: 5s; }
.particle:nth-child(2) { width: 35px; height: 35px; top: 30%; left: 25%; animation-duration: 7s; }
.particle:nth-child(3) { width: 50px; height: 50px; top: 60%; left: 10%; animation-duration: 6s; }
.particle:nth-child(4) { width: 25px; height: 25px; top: 70%; left: 40%; animation-duration: 9s; }
.particle:nth-child(5) { width: 40px; height: 40px; top: 20%; right: 20%; animation-duration: 4s; }
.particle:nth-child(6) { width: 60px; height: 60px; top: 50%; right: 15%; animation-duration: 10s; }
.particle:nth-child(7) { width: 30px; height: 30px; bottom: 15%; right: 25%; animation-duration: 6s; }
.particle:nth-child(8) { width: 20px; height: 20px; bottom: 25%; left: 30%; animation-duration: 8s; }
.particle:nth-child(9) { width: 70px; height: 70px; top: 35%; left: 50%; animation-duration: 12s; }
.particle:nth-child(10) { width: 15px; height: 15px; bottom: 10%; right: 10%; animation-duration: 5s; }

/* Animasi scaling */
@@keyframes floatParticle {
    0%, 100% { transform: scale(0.8); opacity: 0.6; }
    50% { transform: scale(1.3); opacity: 1; }
}

.icon-pajak {
    font-size: 2rem;   /* samakan dengan ukuran h5 agar seimbang */
    color: #495057;    /* opsional, biar matching dengan tema teks */
    line-height: 1;    /* biar rapih sejajar */
}
</style>
 *@
<style>
    /* Default tampil */
    #lokasi {
        display: block;
    }

    #lokasi-nav {
        display: none;
    }

    /* Sembunyikan jika layar <= 768px */
    @@media (max-width: 768px) {
        #lokasi {
            display: none;
        }

        #lokasi-nav {
            display: block;
        }
    }
</style>
<input type="hidden" id="DetailNOP" value="@Model.DataDetail.IdentitasPajak.NOP" />
<input type="hidden" id="DetailJenisPajak" value="@((int)Model.Pajak)" />

<div class="row">

    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <div class="row gx-lg-5">

                    <div class="col-xl-12">
                        <div class="mt-xl-0 mt-5">
                            <div class="d-flex">
                                <div class="flex-grow-1">
                                    @switch (Model.Pajak)
                                    {
                                        case EnumFactory.EPajak.PBB:
                                            <h4 class="text-primary d-block fs-20 fw-bold">@Model.DataDetail.IdentitasPajak.NamaNpwpd</h4>
                                            <div class="hstack gap-3 flex-wrap">
                                                <div class="text-body fw-medium fs-14">@Model.DataDetail.IdentitasPajak.FormattedNOP</div>
                                                <div class="vr"></div>
                                                <div class="text-body fw-medium fs-14">@Model.DataDetail.IdentitasPajak.AlamatLengkap</div>
                                            </div>
                                            break;
                                        default:
                                            <h4 class="text-primary d-block fs-20 fw-bold">@Model.DataDetail.IdentitasPajak.NamaObjekPajak</h4>
                                            <div class="hstack gap-3 flex-wrap">
                                                <div class="text-body fw-medium fs-14">@Model.DataDetail.IdentitasPajak.FormattedNOP</div>
                                                <div class="vr"></div>
                                                <div class="text-body fw-medium fs-14">@Model.DataDetail.IdentitasPajak.AlamatLengkap</div>
                                            </div>
                                            break;
                                    }
                                </div>
                            </div>

                            <div class="d-flex mt-2">
                                <div class="flex-grow-1">
                                    <div class="hstack gap-3 flex-wrap">
                                        <div class="text-body fw-medium fs-14">@Model.DataDetail.IdentitasPajak.JenisPajak</div>
                                        <div class="vr"></div>
                                        <div class="text-body fw-medium fs-14 text-decoration-underline" style="cursor: pointer" onclick="openDetailNewTab('@Model.DataDetail.IdentitasPajak.NOP', '@((int)Model.Pajak)', '@Model.DataDetail.IdentitasPajak.kategoriID')">
                                            <i class="ri-external-link-line align-middle me-1"></i> Potensi
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div class="row mt-4">
                                <div class="col-lg-3 col-sm-6">
                                    <div class="p-2 border border-succes rounded">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm me-2">
                                                <div class="avatar-title rounded bg-transparent text-success fs-24">
                                                    <i class="ri-exchange-line"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                <p class="text-muted mb-1">Realisasi Tahun Ini :</p>
                                                <div class="text-body fw-medium fs-14">@Extension.FormatRupiah(Model.DataDetail.IdentitasPajak.RealisasiTahun)</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- end col -->
                                <div class="col-lg-3 col-sm-6">
                                    <div class="p-2 border border-dashed rounded">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm me-2">
                                                <div class="avatar-title rounded bg-transparent text-success fs-24">
                                                    <i class="ri-file-copy-2-fill"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                <p class="text-muted mb-1">Kategori Pajak :</p>
                                                <div class="text-body fw-medium fs-14">@CultureInfo.CurrentCulture.TextInfo.ToTitleCase(@Model.DataDetail.IdentitasPajak.KategoriPajak.ToLower())</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- end col -->
                                <div class="col-lg-3 col-sm-6">
                                    <div class="p-2 border border-dashed rounded">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm me-2">
                                                <div class="avatar-title rounded bg-transparent text-success fs-24">
                                                    <i class="ri-stack-fill"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                <p class="text-muted mb-1">Wilayah Pajak :</p>
                                                <div class="text-body fw-medium fs-14">Surabaya @Model.DataDetail.IdentitasPajak.WilayahPajak</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- end col -->
                                <div class="col-lg-3 col-sm-6">
                                    <div class="p-2 border border-dashed rounded">
                                        <div class="d-flex align-items-center">
                                            <div class="avatar-sm me-2">
                                                <div class="avatar-title rounded bg-transparent text-success fs-24">
                                                    <i class="ri-inbox-archive-fill"></i>
                                                </div>
                                            </div>
                                            <div class="flex-grow-1">
                                                <p class="text-muted mb-1">Tanggal Buka :</p>
                                                <div class="text-body fw-medium fs-14">@Model.DataDetail.IdentitasPajak.TanggalBuka.ToString("dd MMMMM yyyy", new CultureInfo("id-ID"))</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- end col -->
                            </div>
                            <hr />

                            <div class="product-content mt-2">
                                <nav>
                                    <ul class="nav nav-tabs nav-tabs-custom nav-success" id="nav-tab" role="tablist">
                                        <li class="nav-item">
                                            <a class="nav-link active" id="nav-speci-tab" data-bs-toggle="tab" href="#nav-speci" role="tab" aria-controls="nav-speci" aria-selected="true">
                                                <i class="ri-wallet-line align-middle me-1"></i>Pembayaran
                                            </a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" id="nav-detail-tab" data-bs-toggle="tab" href="#nav-detail" role="tab" aria-controls="nav-detail" aria-selected="false">
                                                <i class="ri-shield-user-line align-middle me-1"></i>Profile
                                            </a>
                                        </li>
                                        @switch (Model.Pajak)
                                        {
                                            case EnumFactory.EPajak.JasaPerhotelan:
                                                <li class="nav-item">
                                                    <a class="nav-link" id="nav-okupansi-tab" data-bs-toggle="tab" href="#nav-okupansi" role="tab" aria-controls="nav-okupansi" aria-selected="false">
                                                        <i class="ri-hotel-bed-line align-middle me-1"></i>Okupansi
                                                    </a>
                                                </li>
                                                break;
                                            default:
                                                break;
                                        }
                                        <li class="nav-item" id="lokasi-nav">
                                            <a class="nav-link" id="nav-lokasi-tab" data-bs-toggle="tab" href="#nav-lokasi" role="tab" aria-controls="nav-lokasi" aria-selected="false">
                                                <i class="ri-map-pin-user-line align-middle me-1"></i>Lokasi
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                                <div class="tab-content border border-top-0 p-4" id="nav-tabContent">
                                    <div class="tab-pane fade show active" id="nav-speci" role="tabpanel" aria-labelledby="nav-speci-tab">
                                        <div class="text-center">
                                            <div id="loading2-PembayaranPajak" class="spinner-border text-primary" style="display: none">
                                                <span class="visually-hidden">Loading...</span>
                                            </div>
                                        </div>
                                        <div id="PembayaranPajak"></div>
                                    </div>
                                    <div class="tab-pane fade" id="nav-detail" role="tabpanel" aria-labelledby="nav-detail-tab">
                                        <div class="card">
                                            <div class="card-header bg-success bg-opacity-50">
                                                <h6 class="mb-0 fw-bold">Identitas Objek Pajak</h6>
                                            </div>
                                            <div class="card-body p-0">
                                                <table class="table mb-0">
                                                    <tbody>
                                                        <tr>
                                                            <th scope="row" style="width: 200px;">NPWPD</th>
                                                            <th scope="row" style="width: 20px;">:</th>
                                                            <td class="text-body fw-medium">@Model.DataDetail.IdentitasPajak.NpwpdNo</td>
                                                        </tr>

                                                        <tr>
                                                            <th scope="row" style="width: 200px;">Nama</th>
                                                            <th scope="row" style="width: 20px;">:</th>
                                                            <td class="text-body fw-medium">
                                                                @switch (Model.Pajak)
                                                                {
                                                                    case EnumFactory.EPajak.PBB:
                                                                        @CultureInfo.CurrentCulture.TextInfo.ToTitleCase(@Model.DataDetail.IdentitasPajak.NamaNpwpd.ToLower())
                                                                        break;
                                                                    default:
                                                                        @CultureInfo.CurrentCulture.TextInfo.ToTitleCase(@Model.DataDetail.IdentitasPajak.NamaObjekPajak.ToLower())
                                                                        break;
                                                                }
                                                            </td>
                                                        </tr>

                                                        <tr>
                                                            <th scope="row" style="width: 200px;">NOP</th>
                                                            <th scope="row" style="width: 20px;">:</th>
                                                            <td class="text-body fw-medium">@Model.DataDetail.IdentitasPajak.FormattedNOP</td>
                                                        </tr>
                                                        <tr>
                                                            <th scope="row" style="width: 200px;">Alamat Lengkap</th>
                                                            <th scope="row" style="width: 20px;">:</th>
                                                            <td class="text-body fw-medium">@CultureInfo.CurrentCulture.TextInfo.ToTitleCase(@Model.DataDetail.IdentitasPajak.AlamatLengkap.ToLower())</td>
                                                        </tr>
                                                        <tr>
                                                            <th scope="row" style="width: 200px;">Wilayah Pajak</th>
                                                            <th scope="row" style="width: 20px;">:</th>
                                                            <td class="text-body fw-medium">Surabaya @Model.DataDetail.IdentitasPajak.WilayahPajak</td>
                                                        </tr>
                                                        <tr>
                                                            <th scope="row" style="width: 200px;">Telp</th>
                                                            <th scope="row" style="width: 20px;">:</th>
                                                            <td class="text-body fw-medium">@Model.DataDetail.IdentitasPajak.Telepon</td>
                                                        </tr>
                                                        <tr>
                                                            <th scope="row" style="width: 200px;">Tanggal Buka</th>
                                                            <th scope="row" style="width: 20px;">:</th>
                                                            <td class="text-body fw-medium">@Model.DataDetail.IdentitasPajak.TanggalBuka.ToString("dd MMMM yyyy", new System.Globalization.CultureInfo("id-ID"))</td>
                                                        </tr>
                                                        <tr>
                                                            <th scope="row" style="width: 200px;">Jenis Pajak</th>
                                                            <th scope="row" style="width: 20px;">:</th>
                                                            <td class="text-body fw-medium">@Model.DataDetail.IdentitasPajak.JenisPajak</td>
                                                        </tr>
                                                        <tr>
                                                            <th scope="row" style="width: 200px;">Kategori Pajak</th>
                                                            <th scope="row" style="width: 20px;">:</th>
                                                            <td class="text-body fw-medium">@CultureInfo.CurrentCulture.TextInfo.ToTitleCase(@Model.DataDetail.IdentitasPajak.KategoriPajak.ToLower())</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="nav-okupansi" role="tabpanel" aria-labelledby="nav-okupansi-tab">
                                        <div class="card">
                                            <div class="card-header d-flex bg-header-color align-items-center">
                                                <div class="flex-grow-1">
                                                    <h4 class="card-title fs-16 text-dark mb-0">
                                                        <i class="bx bx-bar-chart-alt me-2"></i>Okupansi @Model.DataDetail.IdentitasPajak.NamaObjekPajak
                                                    </h4>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <center>
                                                        <div class="col-lg-6">
                                                            @(
                                                                                                                        Html.DevExtreme().DataGrid<MonPDReborn.Models.DataOP.ProfileOPVM.DetailHotel.AccHotel>()
                                                                                                                        .ID("okupansiGrid")
                                                                                                                        .DataSource(Model.DataDetail.HotelRow.AccHotelDetailList)
                                                                                                                        .KeyExpr("Bulan")
                                                                                                                        .ShowBorders(true)
                                                                                                                        .ShowColumnLines(true)
                                                                                                                        .Paging(p => p.PageSize(12))
                                                                                                                        .Columns(columns =>
                                                                                                                        {
                                                                                                                            columns.AddFor(m => m.BulanNama).Caption("Bulan");
                                                                                                                            columns.AddFor(m => m.TahunMines1).Caption(tahunMin1);
                                                                                                                            columns.AddFor(m => m.TahunNow).Caption(tahunNow);
                                                                                                                        })
                                                                                                                        .Summary(s =>
                                                                                                                        {
                                                                                                                            s.TotalItems(items =>
                                                                                                                            {
                                                                                                                                items.AddFor(x => x.BulanNama)
                                                                                                                            .SummaryType(SummaryType.Sum)
                                                                                                                            .DisplayFormat("Average");

                                                                                                                                items.AddFor(x => x.TahunMines1)
                                                                                                                            .SummaryType(SummaryType.Avg)
                                                                                                                            .ValueFormat("#,##0.00")
                                                                                                                            .DisplayFormat("{0}");

                                                                                                                                items.AddFor(x => x.TahunNow)
                                                                                                                            .SummaryType(SummaryType.Avg)
                                                                                                                            .ValueFormat("#,##0.00")
                                                                                                                            .DisplayFormat("{0}");
                                                                                                                            });

                                                                                                                        })
                                                                                                                        )
                                                        </div>
                                                    </center>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="tab-pane fade" id="nav-lokasi" role="tabpanel" aria-labelledby="nav-lokasi-tab">
                                        <iframe width="100%"
                                                height="400"
                                                style="border:0;"
                                                allowfullscreen
                                                loading="lazy"
                                                referrerpolicy="no-referrer-when-downgrade"
                                                src="https://www.google.com/maps?q=@(Uri.EscapeDataString((Model.DataDetail.IdentitasPajak.NamaObjekPajak ?? "") + ", " + (Model.DataDetail.IdentitasPajak.AlamatLengkap ?? "") + ", Surabaya"))&output=embed">
                                        </iframe>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                    <!-- end col -->
                </div>
                <!-- end row -->
            </div>
            <!-- end card body -->
        </div>
        <!-- end card -->
    </div>
    <!-- end col -->
</div>
<!-- end row -->
@section Scripts {
    <script>
        // Fungsi untuk bind event di _Detail dropdown
        // function attachDetailEvents() {
        //     $("#tahunKiri").off("change").on("change", function () {
        //         let tahun = $(this).val();
        //         loadDetailTabel("#tabelKiri", tahun);
        //     });

        //     $("#tahunKanan").off("change").on("change", function () {
        //         let tahun = $(this).val();
        //         loadDetailTabel("#tabelKanan", tahun);
        //     });
        // }

                $(document).on("change", "#tahunKiri", function () {
            fnPembayaranPajak();
        });

        $(document).on("change", "#tahunKanan", function () {
            fnPembayaranPajak();
        });

        function fnPembayaranPajak() {
            const nop = $('#DetailNOP').val();
            const jenisPajak = $('#DetailJenisPajak').val();

            const tahunKiri = $('#tahunKiri').val() || new Date().getFullYear();
            const tahunKanan = $('#tahunKanan').val() || (tahunKiri - 1); // otomatis tahun kiri - 1

            $.ajax({
                url: '@Url.Action("Detail", "ProfilePembayaranOP")',
                type: 'GET',
                data: {
                    nop: nop,
                    jenisPajak: jenisPajak,
                    tahunKiri: tahunKiri,
                    tahunKanan: tahunKanan
                },
                beforeSend: function () {
                    $('#loading2-PembayaranPajak').show();
                    $('#PembayaranPajak').hide();
                },
                success: function (response) {
                    $('#loading2-PembayaranPajak').hide();
                    $('#PembayaranPajak').show().html(response);
                },
                error: function () {
                    $('#loading2-PembayaranPajak').hide();
                    $('#PembayaranPajak').show().html('<p class="text-danger">Terjadi kesalahan saat memuat data.</p>');
                }
            });
        }


        // Bind event ke dropdown
        $(document).on("change", "#tahunKiri, #tahunKanan", function () {
            fnPembayaranPajak();
        });

        // Panggil sekali saat halaman load
        $(document).ready(function () {
            fnPembayaranPajak();
        });

    </script>

    <script>
        function openDetailNewTab(nop, pajak, KategoriId) {
            if (!nop || !pajak || !KategoriId) return;

            const url = `/ProfilePotensiOP/DetailPotensiOP` +
                `?nop=${encodeURIComponent(nop)}` +
                `&jenisPajak=${encodeURIComponent(pajak)}` +
                `&kategori=${encodeURIComponent(KategoriId)}`;

            window.open(url, '_blank');
        }
    </script>
}

