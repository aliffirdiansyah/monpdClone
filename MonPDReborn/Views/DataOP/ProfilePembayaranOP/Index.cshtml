@model MonPDReborn.Models.DataOP.ProfilePembayaranOPVM.Index

@{
    ViewData["Title"] = "Profil Pembayaran Objek Pajak";
    Layout = "_Layout";
}


<div class="card">
    <div class="card-header d-flex">
        <div class="flex-grow-1">
            <h4 class="card-title fs-16 mb-1">
                Profil Pembayaran Objek Pajak
            </h4>
        </div>
    </div>
    <div class="card-body">
        <form id="formPencarian" method="get" asp-action="Show" onsubmit="return false;">
            <div class="row mb-3 align-items-center gx-2">
                <div class="col-lg-3">
                    @Html.DropDownListFor(model => model.SelectedPajak,
                    new SelectList(Model.JenisPajakList, "Value", "Text"),
                                        "Semua Jenis Pajak",
                                        new { @class = "form-select rounded-pill", @aria_label = "Default select example", id = "JenisPajak" })
                </div>

                <div class="col-lg-6 d-flex">
                    @Html.TextBoxFor(model => model.Keyword, new {
                                        @class = "form-control rounded-pill",
                                        @placeholder = "Masukkan Keyword",
                                        id = "Keyword"
                                        })
                    <button type="button"
                            class="btn btn-primary rounded-pill ms-2"
                            style="min-width: 100px;"
                            onclick="fnShow()">
                        <i class="ri-search-eye-line label-icon align-middle fs-16 me-1"></i> Cari
                    </button>
                </div>
            </div>
        </form>

    </div>
</div>

<div class="text-center">
    <div id="loading2-Show" class="spinner-border text-primary" style="display: none">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div id="card-Show" class="card" style="display:none">
    <div class="card-header d-flex">
        <div class="flex-grow-1">
            <h4 class="card-title">Profil Pembayaran Objek Pajak</h4>
        </div>
        <div class="flex-shrink-0">
            <button id="btnLoadDetail" class="btn btn-primary">
                <i class="ri-search-line"></i> Lihat Detail

            </button>
        </div>
    </div>
    <div class="card-body">
        <div id="Show"></div>
    </div>
</div>



@section Scripts {
    <script>
        function fnShow() {
            let keyword = $("#Keyword").val();
            let jenisPajak = $("#JenisPajak").val();

            if (!jenisPajak || !keyword) {
                Swal.fire({
                    icon: 'warning',
                    title: '<b style="color:orange">Peringatan</b>',
                    text: 'Silakan pilih Jenis Pajak dan isi Keyword terlebih dahulu.'
                });
                return;
            }

            $.ajax({
                url: '@Url.Action("Show")',
                type: 'GET',
                data: {
                    jenisPajak: jenisPajak,
                    keyword: keyword
                },
                beforeSend: function () {
                    $("#card-Show").hide();
                    $("#loading2-Show").show();
                },
                success: function (response) {
                    if (response.Status === undefined) {
                        $("#Show").html(response);
                        $("#card-Show").show();

                        // setelah Show tampil, attach event listener untuk dropdown tahun di Detail
                        attachDetailEvents();
                    } else {
                        Swal.fire({
                            icon: 'warning',
                            title: '<b style="color:orange">Peringatan</b>',
                            text: response.Message
                        });
                    }
                },
                error: function () {
                    $('#Show').html('<p class="text-danger">Terjadi kesalahan saat memuat data.</p>');
                },
                complete: function () {
                    $("#loading2-Show").hide();
                }
            });
        }

       // Fungsi untuk bind event di _Detail dropdown
        function attachDetailEvents() {
            $("#tahunKiri").off("change").on("change", function () {
                let tahun = $(this).val();
                loadDetailTabel("#tabelKiri", tahun);
            });

            $("#tahunKanan").off("change").on("change", function () {
                let tahun = $(this).val();
                loadDetailTabel("#tabelKanan", tahun);
            });
        }

        
        $(document).ready(function () {
            // kalau ada default keyword dari model, panggil show
            @if (!string.IsNullOrEmpty(Model.Keyword))
            {
                    <text>fnShow();</text>
            }
        });

        $(document).on('click', '#btnLoadDetail', function () {
            loadDetail();
        });




                                function loadDetail() {
            const nop = $("#Keyword").val();
            const jenisPajak = $("#JenisPajak").val();

            if (!nop || !jenisPajak) {
                Swal.fire({
                    icon: 'warning',
                    title: '<b style="color:orange">Peringatan</b>',
                    text: 'Silakan pilih Jenis Pajak dan isi Keyword terlebih dahulu.'
                });
                return;
            }

            const tahunKiri = new Date().getFullYear();
            const tahunKanan = tahunKiri - 1; // otomatis minus 1

            $("#tahunKiri").val(tahunKiri);
            $("#tahunKanan").val(tahunKanan);

            // load awal → isi full detail (dua tabel sekaligus)
            $("#detailContainer").load('/ProfilePembayaranOP/Detail?' + $.param({
                nop: nop,
                jenisPajak: jenisPajak,
                tahunKiri: tahunKiri,
                tahunKanan: tahunKanan
            }));
        }

        $(document).on("change", "#tahunKiri", function () {
            const tahunKiri = parseInt($(this).val()) || new Date().getFullYear();
            $("#tahunKanan").val(tahunKiri - 1);

            changeTahun('kiri', tahunKiri);
        });

        $(document).on("change", "#tahunKanan", function () {
            const tahunKanan = parseInt($(this).val()) || (new Date().getFullYear() - 1);
            changeTahun('kanan', tahunKanan);
        });

        function changeTahun(side, tahun) {
            const nop = $('#DetailNOP').val();
            const jenisPajak = $('#DetailJenisPajak').val();

            const tahunKiri = (side === 'kiri') ? tahun : $('#tahunKiri').val();
            const tahunKanan = (side === 'kanan') ? tahun : $('#tahunKanan').val();

            // Panggil action Detail (selalu return full _Detail.cshtml)
            $.get('/ProfilePembayaranOP/Detail', {
                nop: nop,
                jenisPajak: jenisPajak,
                tahunKiri: tahunKiri,
                tahunKanan: tahunKanan
            }).done(function (html) {
                // temp div untuk parsing partial
                const $temp = $('<div>').html(html);

                if (side === 'kiri') {
                    // ambil hanya tabel kiri
                    $("#tabelKiri").html($temp.find("#tabelKiri").html());
                } else {
                    // ambil hanya tabel kanan
                    $("#tabelKanan").html($temp.find("#tabelKanan").html());
                }
            });
        }




    </script>
}
