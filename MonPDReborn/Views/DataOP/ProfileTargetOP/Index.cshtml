@model MonPDReborn.Models.DataOP.ProfileTargetOPVM.Index

@{
    ViewData["Title"] = "Profile Target";
    Layout = "_Layout";
}

<div class="row">

    <div class="col-lg-12">
        <div class="card">
            <div class="card-header d-flex align-items-center justify-content-between">
                <div>
                    <h4 class="card-title fs-16 mb-1">
                        Dashboard Target Pajak Daerah
                    </h4>
                    <p class="fs-14 text-muted">Monitoring dan Analisis Target Penerimaan Pajak</p>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <!-- Badge -->
                    <span class="badge bg-primary d-flex align-items-center px-3 py-2">
                        <i class="ri-calendar-fill me-1"></i> Tahun
                    </span>

                    <!-- Dropdown Button -->
                    <div class="dropdown">
                        <button class="btn btn-sm btn-primary dropdown-toggle px-3 py-2" type="button" id="dropdownYearBtn" data-bs-toggle="dropdown" aria-expanded="false">
                            2020
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownYearBtn">
                            <li><a class="dropdown-item" href="#">2020</a></li>
                            <li><a class="dropdown-item" href="#">2021</a></li>
                            <li><a class="dropdown-item" href="#">2022</a></li>
                            <li><a class="dropdown-item" href="#">2023</a></li>
                            <li><a class="dropdown-item" href="#">2024</a></li>
                            <li><a class="dropdown-item" href="#">2025</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-3">
        <div class="card shadow-sm p-3">
            <h4 class="fs-14 text-muted mb-3">Total Target Pajak</h4>
            <h4 class="fs-16 fw-bold mb-1">Rp 000.000.000.000</h4>
            <small>+0.0% dari tahun lalu</small>
        </div>
    </div>

    <div class="col-lg-3">
        <div class="card shadow-sm p-3">
            <h4 class="fs-14 text-muted mb-3">Jenis Pajak Tertinggi</h4>
            <h4 class="fs-16 fw-bold mb-1">Jenis Pajak</h4>
            <small>Rp 000.000.000.000</small>
        </div>
    </div>

    <div class="col-lg-3">
        <div class="card shadow-sm p-3">
            <h4 class="fs-14 text-muted mb-3">Wilayah Target Tertinggi</h4>
            <h4 class="fs-16 fw-bold mb-1">Wilayah</h4>
            <small>Rp 000.000.000.000</small>
        </div>
    </div>

    <div class="col-lg-3">
        <div class="card shadow-sm p-3">
            <h4 class="fs-14 text-muted mb-3">Bulan Target Tertinggi</h4>
            <h4 class="fs-16 fw-bold mb-1">Bulan</h4>
            <small>Rp 000.000.000.000</small>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <div class="flex-grow-1">
                    <h4 class="card-title fs-16 mb-0">
                        Distribusi Target per Jenis Pajak
                    </h4>
                </div>
            </div>
            <div class="card-body">
                <div id="simple_pie_chart" class="apex-charts" style="height:382px" dir="ltr"></div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card">
            <div class="card-header">
                <div class="flex-grow-1">
                    <h4 class="card-title fs-16 mb-0">
                        Distribusi Target per Wilayah (UPTB)
                    </h4>
                </div>
            </div>
            <div class="card-body">
                <div class="card-body">
                    <div id="column_distributed" data-colors='["--vz-primary", "--vz-success", "--vz-warning", "--vz-danger", "--vz-dark"]' class="apex-charts" style="height:350px" dir="ltr"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <div class="flex-grow-1">
                    <h4 class="card-title fs-16 mb-0">
                        Distribusi Target per Bulan
                    </h4>
                </div>
            </div>
            <div class="card-body">
                <div id="line_chart_datalabel" data-colors='["--vz-primary"]' class="apex-charts" dir="ltr"></div>
            </div>
        </div>
    </div>

    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <div class="flex-grow-1">
                    <h4 class="card-title fs-16 mb-0">
                        Total Detail Target Pajak
                    </h4>
                </div>
            </div>
            <div class="card-body">
                <div id="Show"></div>
            </div>
        </div>
    </div>
</div>


@section Scripts{
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var options = {
                chart: {
                    type: 'pie',
                    height: 382
                },
                series: [44, 55, 41, 17, 15, 23, 12, 30], // Data total per jenis pajak
                labels: ['Hotel', 'Restoran', 'Hiburan', 'Parkir', 'PBB', 'BPHTB', 'Reklame', 'PPJ'],
                colors: [
                    '#556ee6', // Hotel
                    '#34c38f', // Restoran
                    '#f1b44c', // Hiburan
                    '#f46a6a', // Parkir
                    '#50a5f1', // PBB
                    '#6f42c1', // BPHTB
                    '#fd7e14', // Reklame
                    '#c05780'  // PPJ-K
                ],
                legend: {
                    position: 'bottom'
                },
                tooltip: {
                    y: {
                        formatter: function (val) {
                            return "Rp " + val.toLocaleString("id-ID");
                        }
                    }
                }
            };

            var chart = new ApexCharts(document.querySelector("#simple_pie_chart"), options);
            chart.render();
        });

        document.addEventListener("DOMContentLoaded", function () {
            var el = document.querySelector("#column_distributed");
            var rawColors = el.getAttribute("data-colors");

            // Ambil nilai CSS variable dan ubah jadi array warna HEX
            var colors = JSON.parse(rawColors).map(function (varName) {
                return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
            });

            var options = {
                chart: {
                    height: 350,
                    type: 'bar'
                },
                plotOptions: {
                    bar: {
                        distributed: true,
                        borderRadius: 4,
                        columnWidth: '60%'
                    }
                },
                dataLabels: {
                    enabled: false
                },
                series: [{
                    data: [150, 250, 180, 300, 120] // Ganti dengan nilai real
                }],
                xaxis: {
                    categories: ['UPTB 1', 'UPTB 2', 'UPTB 3', 'UPTB 4', 'UPTB 5'],
                    labels: {
                        style: {
                            colors: colors,
                            fontSize: '14px'
                        }
                    }
                },
                colors: colors,
                legend: {
                    show: false
                },
                tooltip: {
                    y: {
                        formatter: function (val) {
                            return 'Rp ' + val.toLocaleString('id-ID');
                        }
                    }
                }
            };

            var chart = new ApexCharts(el, options);
            chart.render();
        });

        document.addEventListener("DOMContentLoaded", function () {
            const el = document.querySelector("#line_chart_datalabel");
            const rawColors = el.getAttribute("data-colors");
            const colors = JSON.parse(rawColors).map(color =>
                getComputedStyle(document.documentElement).getPropertyValue(color).trim()
            );

            fetch('@Url.Action("GetTargetChartData", "ProfileTargetOP")')
                .then(res => res.json())
                .then(data => {
                    const options = {
                        chart: { height: 350, type: 'line' },
                        dataLabels: { enabled: true },
                        stroke: { curve: 'smooth', width: 3 },
                        series: data.series,
                        colors: colors,
                        xaxis: { categories: data.categories },
                        tooltip: {
                            y: { formatter: val => 'Rp ' + val.toLocaleString('id-ID') }
                        },
                        legend: {
                            show: true,
                            position: 'top',
                            horizontalAlign: 'right'
                        }
                    };
                    const chart = new ApexCharts(el, options);
                    chart.render();
                });
        });

        // Saat halaman selesai dimuat
        $(document).ready(function () {
            loadShow("");       // Load rekap awal
        });

        // Fungsi untuk memuat data rekap pemeriksaan
        function loadShow() {
            $.ajax({
                url: '@Url.Action("Show", "ProfileTargetOP")',
                type: 'GET',
                success: function (result) {
                    $('#Show').html(result);
                },
                error: function () {
                    $('#Show').html('<div class="alert alert-danger">Gagal memuat data rekap.</div>');
                }
            });
        }
    </script>
}