@model MonPDReborn.Models.EvaluasiTarget.KontrolPembayaranVM.Index

@{
    ViewData["Title"] = "Kontrol Pembayaran";
    Layout = "_Layout";
}

<div class="row">

    <div class="col-lg-12">
        <div class="card">
            <div class="card-header d-flex bg-header-color align-items-center">
                <div class="flex-grow-1">
                    <h4 class="card-title text-dark fs-16 mb-0">
                        Dashboard Kontrol Pembayaran
                    </h4>
                </div>
            </div>
            <div class="card-body">
                
                <!-- Filter Tahun -->
                <div class="d-flex mb-3" id="tahunGroup">
                    <button class="btn btn-outline-primary tahun-link me-2 active" data-tahun="2025">2025</button>
                    <button class="btn btn-outline-primary tahun-link me-2" data-tahun="2024">2024</button>
                    <button class="btn btn-outline-primary tahun-link me-2" data-tahun="2023">2023</button>
                </div>

                <!-- Tab Jenis Pajak -->
                <ul class="nav nav-tabs mb-4" id="jenisPajakTabs">
                    <li class="nav-item">
                        <a class="nav-link jenis-pajak-tab active" href="#" data-jenis="Hotel">Hotel</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link jenis-pajak-tab" href="#" data-jenis="Restoran">Restoran</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link jenis-pajak-tab" href="#" data-jenis="Parkir">Parkir</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link jenis-pajak-tab" href="#" data-jenis="Hiburan">Hiburan</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link jenis-pajak-tab" href="#" data-jenis="PPJ">PPJ</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link jenis-pajak-tab" href="#" data-jenis="ABT">ABT</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link jenis-pajak-tab" href="#" data-jenis="PBB">PBB</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link jenis-pajak-tab" href="#" data-jenis="AirTanah">AirTanah</a>
                    </li>
                </ul>

                <!-- Kontainer Dinamis untuk Masing-Masing Jenis Pajak -->
                @{
                    var jenisPajakList = new[] { "Hotel", "Restoran", "Parkir", "Hiburan", "PPJ", "ABT", "PBB", "AirTanah" };
                }

                @foreach (var jenis in jenisPajakList)
                {
                    var isFirst = (jenis == jenisPajakList.First());
                    <div id="container-@jenis" class="tab-content" style="display:@(isFirst ? "block" : "none");">
                        <h4 class="card-title fs-16 mb-1">Kontrol Pembayaran Pajak</h4>
                        <div id="kontrolPembayaranContainer-@jenis" class="mb-5"></div>
                        <div id="kontrolPembayaranSpinner-@jenis" style="display:none">Loading pembayaran…</div>

                        <h4 class="card-title fs-16 mb-1">Kontrol Upaya Pajak</h4>
                        <div id="kontrolUpayaContainer-@jenis" class="mb-5"></div>
                        <div id="kontrolUpayaSpinner-@jenis" style="display:none">Loading upaya…</div>

                        <h4 class="card-title fs-16 mb-1">Kontrol Potensi Pajak</h4>
                        <div id="kontrolPotensiContainer-@jenis"></div>
                        <div id="kontrolPotensiSpinner-@jenis" style="display:none">Loading potensi…</div>
                    </div>
                }

                
                <div class="modal fade" id="modalDetailPajak" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" role="dialog">
                    <div class="modal-dialog modal-xl" role="document">
                        <div class="modal-content">
                            <div class="modal-header d-flex">
                                <div class="flex-grow-1">
                                    <h4 class="modal-title fs-16 mb-0">
                                        Data OP Pembayaran Pajak
                                    </h4>
                                </div>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="text-center p-3">Loading…</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal fade" id="modalDetailUpaya" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" role="dialog">
                    <div class="modal-dialog modal-xl" role="document">
                        <div class="modal-content">
                            <div class="modal-header d-flex">
                                <div class="flex-grow-1">
                                    <h4 class="modal-title fs-16 mb-0">
                                        Data OP Upaya Pembayaran Pajak
                                    </h4>
                                </div>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="text-center p-3">Loading…</div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script>
        let currentJenis = 'Hotel';
        let currentTahun = 2025;

        function showLoadingFor(jenisPajak) {
            // Sembunyikan semua kontainer pajak
            $('[id^="container-"]').hide();

            // Tampilkan hanya kontainer jenis pajak saat ini
            $(`#container-${jenisPajak}`).show();

            // Tampilkan semua spinner untuk jenis pajak ini
            $(`#kontrolPembayaranSpinner-${jenisPajak}`).show();
            $(`#kontrolUpayaSpinner-${jenisPajak}`).show();
            $(`#kontrolPotensiSpinner-${jenisPajak}`).show();

            // Sembunyikan semua konten data
            $(`#kontrolPembayaranContainer-${jenisPajak}`).hide();
            $(`#kontrolUpayaContainer-${jenisPajak}`).hide();
            $(`#kontrolPotensiContainer-${jenisPajak}`).hide();
        }

        function loadShow(jenisPajak, tahun) {
            currentJenis = jenisPajak; // pastikan variabel global ikut berubah
            currentTahun = tahun;

            console.log(`Load untuk ${jenisPajak} tahun ${tahun}`);

            // Tab aktif untuk jenis pajak
            $('.jenis-pajak-tab').removeClass('active');
            $(`.jenis-pajak-tab[data-jenis="${jenisPajak}"]`).addClass('active');

            // Tab aktif untuk tahun
            $('#tahunGroup .tahun-link').removeClass('active');
            $(`#tahunGroup .tahun-link[data-tahun="${tahun}"]`).addClass('active');

            // Tampilkan spinner loading
            showLoadingFor(jenisPajak);

            // === AJAX: Pembayaran ===
            $.ajax({
                url: '/KontrolPembayaran/Show',
                data: { jenisPajak, tahun },
                success: function (html) {
                    $(`#kontrolPembayaranSpinner-${jenisPajak}`).hide();
                    const container = $(`#kontrolPembayaranContainer-${jenisPajak}`);
                    container.html(html).show();

                    // Eksekusi script di dalam HTML
                    container.find("script").each(function () {
                        $.globalEval(this.text || this.textContent || this.innerHTML || '');
                    });
                },
                error: function () {
                    $(`#kontrolPembayaranSpinner-${jenisPajak}`).hide();
                    $(`#kontrolPembayaranContainer-${jenisPajak}`).html(
                        '<div class="text-danger">Gagal memuat data pembayaran.</div>'
                    ).show();
                }
            });

            // === AJAX: Upaya ===
            $.ajax({
                url: '/KontrolPembayaran/ShowUpaya',
                data: { jenisPajak, tahun },
                success: function (html) {
                    $(`#kontrolUpayaSpinner-${jenisPajak}`).hide();
                    const container = $(`#kontrolUpayaContainer-${jenisPajak}`);
                    container.html(html).show();

                    container.find("script").each(function () {
                        $.globalEval(this.text || this.textContent || this.innerHTML || '');
                    });
                },
                error: function () {
                    $(`#kontrolUpayaSpinner-${jenisPajak}`).hide();
                    $(`#kontrolUpayaContainer-${jenisPajak}`).html(
                        '<div class="text-danger">Gagal memuat data upaya.</div>'
                    ).show();
                }
            });

            // === AJAX: Potensi ===
            $.ajax({
                url: '/KontrolPembayaran/ShowPotensi',
                data: { jenisPajak, tahun },
                success: function (html) {
                    $(`#kontrolPotensiSpinner-${jenisPajak}`).hide();
                    const container = $(`#kontrolPotensiContainer-${jenisPajak}`);
                    container.html(html).show();

                    container.find("script").each(function () {
                        $.globalEval(this.text || this.textContent || this.innerHTML || '');
                    });
                },
                error: function () {
                    $(`#kontrolPotensiSpinner-${jenisPajak}`).hide();
                    $(`#kontrolPotensiContainer-${jenisPajak}`).html(
                        '<div class="text-danger">Gagal memuat data potensi.</div>'
                    ).show();
                }
            });
        }

        $(document).ready(function () {
            // Load default saat halaman pertama dibuka
            loadShow(currentJenis, currentTahun);

            // Klik Tahun
            $('#tahunGroup').on('click', '.tahun-link', function (e) {
                e.preventDefault();
                const tahunDipilih = $(this).data('tahun');
                loadShow(currentJenis, tahunDipilih);
            });

            // Klik Jenis Pajak
            $('#jenisPajakTabs').on('click', '.jenis-pajak-tab', function (e) {
                e.preventDefault();
                const jenisDipilih = $(this).data('jenis');
                loadShow(jenisDipilih, currentTahun);
            });
        });

        function showPajakCellTemplate(cellElement, cellInfo) {
            const jenisPajakMap = {
                'Restoran': 1,
                'PPJ': 2,
                'Hotel': 3,
                'Parkir': 4,
                'Hiburan': 5,
                'AirTanah': 6,
                'Reklame': 7,
                'PBB': 9,
                'BPHTB': 12,
            };
            const jenisPajak = jenisPajakMap[currentJenis] || 0;
            const kategoriId = cellInfo.data.kategoriId;
            const tahun = currentTahun;

            // Ambil angka bulan dari nama field (contoh: Byr1 → 1)
            const fieldName = cellInfo.column.dataField || '';
            const matchBulan = fieldName.match(/\d+$/);
            const bulan = matchBulan ? parseInt(matchBulan[0]) : 0;

            // Ambil status dari caption kolom
            const colCaption = cellInfo.column.caption?.toUpperCase() || '';
            let status = '';
            if (colCaption.includes('BYR')) {
                status = '1';
            } else if (colCaption.includes('N/TS')) {
                status = '2';
            } else if (colCaption.includes('BLM')) {
                status = '0';
            } else if (colCaption.includes('OP BUKA')) {
                status = '3';
            }

            const $link = $('<a>')
                .addClass('value-link text-decoration-none')
                .attr('href', 'javascript:void(0);')
                .attr('title', `Lihat Detail ${status}`)
                .text((cellInfo.value ?? 0).toLocaleString('id-ID'))
                .on('click', () => onPajakClick(jenisPajak, kategoriId, tahun, bulan, status));

            $(cellElement).append($link);
        }






    </script>


    <script>

        




        function upayaPajakCellTemplate(cellElement, cellInfo) {
            const jenisPajak = cellInfo.data.JenisPajak;
            const kategori = cellInfo.data.Kategori;
            const tahun = 2025; // atau bisa pakai cellInfo.data.Tahun jika tersedia

            // Tentukan status berdasarkan caption kolom
            let status = '';
            const caption = cellInfo.column.caption?.toUpperCase();

            if (caption.includes('HIMB')) {
                status = 'HIMB';
            } else if (caption.includes('TEGUR')) {
                status = 'TEGUR';
            } else if (caption.includes('SIL')) {
                status = 'SIL';
            } else if (caption.includes('KEJAK')) {
                status = 'KEJAK';
            }

            const $link = $('<a>')
                .addClass('value-link text-decoration-none')
                .attr('href', 'javascript:void(0);')
                .attr('title', `Lihat Detail ${status}`)
                .text((cellInfo.value ?? 0).toLocaleString('id-ID'))
                .on('click', () => onUpayaClick(jenisPajak, kategori, tahun, status));

            $(cellElement).append($link);
        }



        function onPajakClick(jenisPajak, kategoriId, tahun, bulan, status) {
            showDetailPajak(jenisPajak, kategoriId, tahun, bulan, status);
        }

        function onUpayaClick(jenisPajak, kategori, tahun, status) {
            showDetailUpaya(jenisPajak, kategori, tahun, status);
        }

        function showDetailPajak(jenisPajak, kategoriId, tahun, bulan, status) {
            $.ajax({
                url: '/KontrolPembayaran/DetailPembayaran',
                type: 'GET',
                data: {
                    jenisPajak: jenisPajak,
                    kategoriId: kategoriId,
                    bulan: bulan,
                    tahun: tahun,
                    status: status
                },
                beforeSend: function () {
                    $('#modalDetailPajak .modal-body').html('<div class="text-center p-3">Loading…</div>');
                    $('#modalDetailPajak').modal('show');
                },
                success: function (html) {
                    $('#modalDetailPajak .modal-body').html(html);
                },
                error: function () {
                    $('#modalDetailPajak .modal-body').html('<div class="text-danger">⚠ Gagal memuat data</div>');
                }
            });
        }

        function showDetailUpaya(jenisPajak, kategori, tahun, status) {
            $.ajax({
                url: '/KontrolPembayaran/ShowDetailUpaya',
                type: 'GET',
                data: {
                    jenisPajak: jenisPajak,
                    kategori: kategori,
                    tahun: tahun,
                    status: status
                },
                beforeSend: function () {
                    $('#modalDetailUpaya .modal-body').html('<div class="text-center p-3">Loading…</div>');
                    $('#modalDetailUpaya').modal('show');
                },
                success: function (html) {
                    $('#modalDetailUpaya .modal-body').html(html);
                },
                error: function () {
                    $('#modalDetailUpaya .modal-body').html('<div class="text-danger">⚠ Gagal memuat data</div>');
                }
            });
        }
    </script>
}

