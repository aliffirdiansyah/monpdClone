@using System.Globalization
@model MonPDReborn.Models.MonitoringWilayah.MonitoringWilayahVM.Show

<div class="row">

    <div class="col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="fs-1 text-primary"><i class="bx bx-target-lock"></i></div>
                <div class="text-uppercase small fw-bold">Total Target</div>
                <div class="fs-4 fw-semibold">@MonPDLib.General.Extension.FormatRupiahFull(Model.TotalTarget)</div>
                <small class="text-muted">Target pajak daerah</small>
            </div>
        </div>
    </div>

    <div class="col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="fs-1 text-success"><i class="bx bx-bar-chart-alt-2"></i></div>
                <div class="text-uppercase small fw-bold">Total Realisasi</div>
                <div class="fs-4 fw-semibold">@MonPDLib.General.Extension.FormatRupiahFull(Model.TotalRealisasi)</div>
                <small class="text-muted"><span class="text-success fw-bold">@Model.PersenTotal.ToString("N1") %</span> dari target</small>
            </div>
        </div>
    </div>

    <div class="col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="fs-1 text-warning"><i class="bx bx-calendar"></i></div>
                <div class="text-uppercase small fw-bold">Pencapaian Harian</div>
                <div class="fs-4 fw-semibold">@MonPDLib.General.Extension.FormatRupiahFull(Model.TotalPencapaianHarian)</div>
                <small class="text-muted">Realisasi Per @DateTime.Now.ToString("dd MMM yyyy", new CultureInfo("id-ID"))
                </small>
            </div>
        </div>
    </div>

    <div class="col-lg-3">
        <div class="card">
            <div class="card-body">
                <div class="fs-1 text-info"><i class="bx bx-user-check"></i></div>
                <div class="text-uppercase small fw-bold">Jumlah Wajib Pajak</div>
                <div class="fs-4 fw-semibold">@Model.TotalWajibPajak.ToString("n0")</div>
                <small class="text-muted"><span class="text-info fw-bold">+127</span> dari bulan sebelumnya</small>
            </div>
            
        </div>
    </div>

    @{
        string col1 = "col-lg-12";
        string col2 = "col-lg-12";
        bool col2Visible = false;

        // Kondisi 1: Wilayah & Pajak = Semua
        if (Model.Wilayah == MonPDLib.General.EnumFactory.EUPTB.SEMUA 
            && Model.JenisPajak == MonPDLib.General.EnumFactory.EPajak.Semua)
        {
            col1 = "col-lg-6";
            col2 = "col-lg-6";
            col2Visible = true;
        }
        // Kondisi 2: Pajak = Semua (apapun wilayahnya)
        else if (Model.JenisPajak == MonPDLib.General.EnumFactory.EPajak.Semua)
        {
            col1 = "col-lg-6";
            col2 = "col-lg-6";
            col2Visible = true;
        }
    }


    <div class="@(col1)">
        <div class="card">
            <div class="card-header d-flex bg-header-color align-items-center">
                <div class="flex-grow-1">
                    <h4 class="card-title text-dark fs-16 mb-1">
                        Realisasi Pajak per UPTB
                    </h4>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
            @(
                Html.DevExtreme().DataGrid<MonPDReborn.Models.MonitoringWilayah.MonitoringWilayahVM.RealisasiWilayah>()
                    .ID("wilayahGrid")
                    .DataSource(Model.RealisasiWilayahList.OrderBy(x => x.Wilayah))
                    .KeyExpr("Wilayah")
                    .ShowBorders(true)
                    .ShowColumnHeaders(true)
                    .ShowColumnLines(true)
                    .ShowRowLines(true)
                    .RowAlternationEnabled(true)
                    .ColumnAutoWidth(true)
                    .Columns(columns => {
                        columns.Add()
                            .Caption("UPTB")
                            .CellTemplate(@<text>
                                <div class="d-flex align-items-center">
                                    <div class="me-2">
                                        <span class="bg-primary bg-opacity-10 text-primary p-2 rounded-circle">
                                            <i class="bx bx-map"></i>
                                        </span>
                                    </div>
                                    <div>
                                        <div class="fw-bold"><%= data.Wilayah %></div>
                                        <small class="text-muted"><%= data.Lokasi %></small>
                                    </div>
                                </div>
                            </text>);

                        columns.AddFor(m => m.Target)
                            .Caption("Target").Format("#,##0")
                            .HeaderCellTemplate(@<text><div class="fw-bold">Target</div></text>);

                        columns.AddFor(m => m.Realisasi)
                            .Caption("Realisasi").Format("#,##0")
                            .HeaderCellTemplate(@<text><div class="fw-bold">Realisasi</div></text>);

                        columns.Add()
                            .Caption("Pencapaian")
                            .CellTemplate(@<text>
                                <% 
                                    var val = data.Pencapaian;
                                    var color = val >= 80 ? "bg-success" : val >= 70 ? "bg-warning" : "bg-danger";
                                %>
                                <div class="d-flex align-items-center w-100">
                                    <div class="me-2 fw-semibold"><%= val %>%</div>
                                    <div class="progress w-100" style="height:6px;">
                                        <div class="progress-bar <%= color %>" style="width:<%= val %>%"></div>
                                    </div>
                                </div>
                            </text>);

                        @* columns.Add()
                            .Caption("Tren")
                            .CellTemplate(@<text>
                                <% 
                                    var status = data.Status;
                                    var tren = data.Tren;
                                    var color = "text-secondary";
                                    var icon = "bx-minus";
                                    if (status == "up") { color = "text-success"; icon = "bx-up-arrow"; }
                                    else if (status == "down") { color = "text-danger"; icon = "bx-down-arrow"; }
                                %>
                                <span class="fw-semibold <%= color %>">
                                    <i class="bx <%= icon %>"></i> <%= tren %>%
                                </span>
                            </text>); *@
                    })
                    .Summary(s =>
                    {
                        s.TotalItems(items =>
                        {
                            items.Add()
                                .Column("UPTB")
                                .SummaryType(SummaryType.Sum)
                                .DisplayFormat("Total");

                            items.Add()
                                .Column("Target")
                                .SummaryType(SummaryType.Sum)
                                .ValueFormat("#,##0")
                                .DisplayFormat("Rp {0}")
                                .Alignment(HorizontalAlignment.Right);

                            items.Add()
                                .Column("Realisasi")
                                .SummaryType(SummaryType.Sum)
                                .ValueFormat("#,##0")
                                .DisplayFormat("Rp {0}")
                                .Alignment(HorizontalAlignment.Right);

                                
                        });
                    })
        )
                </div>
            </div>
        </div>
    </div>

    @if (col2Visible)
    {
    <div class="@(col2)">
        <div class="card">
            <div class="card-header d-flex bg-header-color align-items-center">
                <div class="flex-grow-1">
                    <h4 class="card-title text-dark fs-16 mb-1">
                        Realisasi Pajak per Jenis
                    </h4>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    @(
                        Html.DevExtreme().DataGrid<MonPDReborn.Models.MonitoringWilayah.MonitoringWilayahVM.RealisasiJenis>()
                            .ID("jenisGrid")
                            .DataSource(Model.RealisasiJenisList.OrderBy(x => x.Wilayah))
                            .KeyExpr("JenisPajak")
                            .ShowBorders(true)
                            .ShowColumnHeaders(true)
                            .ShowColumnLines(true)
                            .ShowRowLines(true)
                            .RowAlternationEnabled(true)
                            .ColumnAutoWidth(true)
                            .Columns(columns => {
                                // Jenis Pajak + jumlah WP dengan ikon
                                columns.AddFor(m => m.JenisPajak)
                                .DataField("JenisPajak")
                                .Caption("Jenis Pajak")
                                .CellTemplate(new JS("jenisPajakCellTemplate"));


                                // Target
                                columns.AddFor(m => m.Target)
                                    .Caption("Target").Format("#,##0");

                                // Realisasi
                                columns.AddFor(m => m.Realisasi)
                                    .Caption("Realisasi").Format("#,##0");

                                // Pencapaian
                                columns.Add()
                                    .Caption("Pencapaian")
                                    .CellTemplate(@<text>
                                        <% 
                                            var val = data.Pencapaian;
                                            var color = val >= 80 ? "bg-success" : val >= 70 ? "bg-warning" : "bg-danger";
                                        %>
                                        <div class="d-flex align-items-center w-100">
                                            <div class="me-2 fw-semibold"><%= val %>%</div>
                                            <div class="progress w-100" style="height:6px;">
                                                <div class="progress-bar <%= color %>" style="width:<%= val %>%"></div>
                                            </div>
                                        </div>
                                    </text>);

                                @* // Tren
                                columns.Add()
                                    .Caption("Tren")
                                    .CellTemplate(@<text>
                                        <% 
                                            var color = "text-secondary";
                                            var icon = "bx-minus";
                                            if (data.Status == "up") { color = "text-success"; icon = "bx-up-arrow"; }
                                            else if (data.Status == "down") { color = "text-danger"; icon = "bx-down-arrow"; }
                                        %>
                                        <span class="fw-semibold <%= color %>">
                                            <i class="bx <%= icon %>"></i> <%= data.Tren %>%
                                        </span>
                                    </text>); *@
                            })
                            .Summary(s =>
                            {
                                s.TotalItems(items =>
                                {
                                    items.Add()
                                        .Column("JenisPajak")
                                        .SummaryType(SummaryType.Sum)
                                        .DisplayFormat("Total");

                                    items.Add()
                                        .Column("Target")
                                        .SummaryType(SummaryType.Sum)
                                        .ValueFormat("#,##0")
                                        .DisplayFormat("Rp {0}")
                                        .Alignment(HorizontalAlignment.Right);

                                    items.Add()
                                        .Column("Realisasi")
                                        .SummaryType(SummaryType.Sum)
                                        .ValueFormat("#,##0")
                                        .DisplayFormat("Rp {0}")
                                        .Alignment(HorizontalAlignment.Right);

                                
                                });
                            })
                        )
                </div>
            </div>
        </div>
    </div>    
    }
</div>


