@model MonPDReborn.Models.KontrolPembayaran.PembayaranKontrolVM.Index

@{
    ViewData["Title"] = "Kontrol Pembayaran";
    Layout = "_Layout";
}

<div class="row">

    <div class="col-lg-12">
        <div class="card">
            <div class="card-header d-flex bg-header-color align-items-center">
                <div class="flex-grow-1">
                    <h4 class="card-title text-dark fs-16 mb-0">
                        Dashboard Kontrol Pembayaran
                    </h4>
                </div>
            </div>
            <div class="card-body">
                <div class="row mt-3 ms-0">

                    <div class="col-lg-3">
                        @(Html.DevExtreme().DateBox()
                                                .ID("tanggal")
                                                .Type(DateBoxType.Date)
                                                .Placeholder("Tanggal")
                                                .StylingMode(EditorStylingMode.Outlined)
                                                .Value(DateTime.Now)
                                                .Max(DateTime.Now)
                                                )
                    </div>

                    <div class="col-lg-3">
                        @(Html.DevExtreme().SelectBox()
                                                .ID("SelectedPajak")
                                                .Value(Model.SelectedPajak)
                                                .DataSource(Model.JenisPajakList)
                                                .DisplayExpr("Text")
                                                .ValueExpr("Value")
                                                .Value(Model.SelectedPajak.ToString())
                                                .SearchEnabled(true)
                                                .StylingMode(EditorStylingMode.Outlined)
                                                .ElementAttr("class", "form-select mb-3")
                                                )
                    </div>

                    <div class="col-lg-3">
                        <button type="button" id="btnTerapkanFilter" class="btn btn-success w-100">
                            Terapkan Filter
                        </button>
                    </div>

                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-12">
        <div class="card">
            <div class="card-header d-flex bg-header-color align-items-center">
                <div class="flex-grow-1">
                    <h4 class="card-title text-dark fs-16 mb-1">
                        Rekap Pembayaran
                    </h4>
                </div>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <div id="loading2-Show" class="spinner-border text-primary" style="display: none">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="Show"></div>
            </div>
        </div>
    </div>

</div>
@section Scripts {
    <script>
        $(document).ready(function () {
            $("#btnTerapkanFilter").on("click", function () {
                // Ambil nilai dari DateBox
                var tanggalObj = $("#tanggal").dxDateBox("instance").option("value");

                // Ubah ke format yyyy-MM-dd (ASP.NET bisa binding otomatis)
                let tanggalStr = null;
                if (tanggalObj) {
                    const yyyy = tanggalObj.getFullYear();
                    const mm = String(tanggalObj.getMonth() + 1).padStart(2, '0');
                    const dd = String(tanggalObj.getDate()).padStart(2, '0');
                    tanggalStr = `${yyyy}-${mm}-${dd}`;
                }

                // Ambil nilai dari SelectBox
                var selectedPajak = $("#SelectedPajak").dxSelectBox("instance").option("value");

                // Cek data
                console.log("Tanggal (Date):", tanggalObj);
                console.log("Tanggal (String):", tanggalStr);
                console.log("Jenis Pajak:", selectedPajak);

                // Kirim ke server dengan AJAX
                $.ajax({
                    url: '/PembayaranKontrol/Show',
                    type: 'GET',
                    data: {
                        tanggal: tanggalStr,
                        jenisPajak: selectedPajak
                    },
                    beforeSend: function () {
                        $("#loading2-Show").show();
                        $("#Show").html("");
                    },
                    success: function (result) {
                        $("#Show").html(result);
                    },
                    error: function () {
                        $("#Show").html("<div class='alert alert-danger'>⚠ Gagal memuat data Show</div>");
                    },
                    complete: function () {
                        $("#loading2-Show").hide();
                    }
                });
            });
        });

    </script>
    <script>
        function onDetail(e) {
            // Ambil data baris yang diklik
            var enumPajak = e.row.enumPajak;

            // Ubah judul modal
            $("#modalTitle").text("Detail Pajak");

            // Kosongkan isi body dulu
            $("#modalBody").html("<div class='text-center p-3'><div class='spinner-border text-primary'></div></div>");

            // Panggil action untuk ambil detail (PartialView)
            $.ajax({
                url: '/PembayaranKontrol/Detail', // ganti dengan Controller/Action detail kamu
                type: 'GET',
                data: { enumPajak: enumPajak },
                success: function (result) {
                    $("#modalBody").html(result);
                },
                error: function () {
                    $("#modalBody").html("<div class='alert alert-danger'>⚠ Gagal memuat detail</div>");
                }
            });

            // Tampilkan modal
            var myModal = new bootstrap.Modal(document.getElementById('staticBackdropLargeScrollable'));
            myModal.show();
        }
    </script>

}