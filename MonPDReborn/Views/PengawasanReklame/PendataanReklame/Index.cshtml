@model MonPDReborn.Models.PengawasanReklame.PendataanReklameVM.Index

<div class="row">

    <div class="col-lg-12">
        <div class="card">
            <div class="card-header d-flex bg-header-color align-items-center">
                <div class="flex-grow-1">
                    <h4 class="card-title fs-16 text-dark mb-0">
                        <i class="bx bx-bar-chart-alt me-2"></i>Pendataan Reklame
                    </h4>
                </div>
            </div>
            <div class="card-body">
                <div class="d-flex gap-2 flex-wrap">
                    <!-- Filter Tahun -->
                    <select id="tahunFilter" class="form-select rounded-pill mb-3" aria-label="Pilih Tahun" style="max-width: 200px;">
                        <option selected disabled>Pilih Tahun</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                    </select>

                    <!-- Filter Bulan -->
                    <select id="bulanFilter" class="form-select rounded-pill mb-3" aria-label="Pilih Bulan" style="max-width: 200px;">
                        <option selected disabled>Pilih Bulan</option>
                        <option value="1">Januari</option>
                        <option value="2">Februari</option>
                        <option value="3">Maret</option>
                        <option value="4">April</option>
                        <option value="5">Mei</option>
                        <option value="6">Juni</option>
                        <option value="7">Juli</option>
                        <option value="8">Agustus</option>
                        <option value="9">September</option>
                        <option value="10">Oktober</option>
                        <option value="11">November</option>
                        <option value="12">Desember</option>
                    </select>

                    <!-- Tombol Filter -->
                    <button type="button" class="btn btn-success rounded-pill mb-3">
                        Terapkan Filter
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-12">
        <div id="cardShow" class="card d-none">
            <div class="card-header d-flex bg-header-color align-items-center">
                <div class="flex-grow-1">
                    <h4 class="card-title text-dark fs-16 mb-0">
                        Permanen
                    </h4>
                </div>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <div id="loading2-Show" class="spinner-border text-primary" style="display: none">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
                <div id="Show"></div>
            </div>
        </div>
    </div>

</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // saat pertama kali: kosongkan hasil
            $('#Show').html('');

            // ketika tombol Terapkan Filter diklik
            $('.btn-success').on('click', function () {
                const tahun = $('#tahunFilter').val();
                const bulan = $('#bulanFilter').val();

                if (!tahun || !bulan) {
                    alert('Silakan pilih Tahun dan Bulan terlebih dahulu.');
                    return;
                }

                // Jika valid, panggil fungsi untuk memuat data
                loadData();

                // Tampilkan card hasil
                $('#cardShow').removeClass('d-none');
            });

            function loadData() {
                let tahun = $('#tahunFilter').val();
                let bulan = $('#bulanFilter').val();

                if (!tahun) {
                    $('#Show').html('<div class="text-danger">⚠ Silakan pilih tahun terlebih dahulu.</div>');
                    return;
                }

                $.ajax({
                    url: '@Url.Action("Show", "PendataanReklame")',
                    type: 'GET',
                    data: {
                        tahun: tahun,
                        bulan: bulan
                    },
                    beforeSend: function () {
                        // Tampilkan spinner, sembunyikan konten
                        $('#loading2-Show').show();
                        $('#Show').hide();
                    },
                    success: function (result) {
                        // Sembunyikan spinner, tampilkan hasil
                        $('#loading2-Show').hide();
                        $('#Show').html(result).show();
                    },
                    error: function (xhr, status, error) {
                        console.error("Gagal memuat data Show:", error);
                        $('#loading2-Show').hide();
                        $('#Show').html('<div class="alert alert-danger">❌ Gagal memuat data Show.</div>').show();
                    }
                });

            }
        });

        let expandedRowKey = null;

        function subDetailTemplate(container, options) {
            var namaKegiatan = options.data?.NamaKegiatan;
            var tahun = options.data?.Tahun;
            var bulan = options.data?.Bulan;

            console.log("subDetailTemplate - NamaKegiatan:", namaKegiatan);
            console.log("Tahun:", tahun, "Bulan:", bulan);

            var innerContainer = $("<div>").addClass("p-2");
            container.append(innerContainer);

            if (!namaKegiatan || !tahun || !bulan) {
                innerContainer.html('<div class="text-danger">Data tidak lengkap (Nama Kegiatan/Tahun/Bulan).</div>');
                return;
            }

            // Spinner
            innerContainer.html(`
                <div class="text-center my-3">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div class="mt-2 text-muted">Memuat data sub-detail...</div>
                </div>
            `);

            $.ajax({
                url: '@Url.Action("Detail", "PendataanReklame")',
                type: 'GET',
                data: {
                    namaKegiatan: namaKegiatan,
                    tahun: tahun,
                    bulan: bulan
                },
                success: function (result) {
                    innerContainer.html(result);
                },
                error: function () {
                    innerContainer.html('<div class="text-danger">❌ Gagal memuat data sub-detail.</div>');
                }
            });
        }


        function onRowExpandingHandler(e) {
            const grid = e.component;

            // Jika ada baris yang sedang terbuka dan berbeda dari baris yang diklik
            if (expandedRowKey && expandedRowKey !== e.key) {
                // Tutup baris sebelumnya
                grid.collapseRow(expandedRowKey);
            }

            // Simpan baris yang sedang dibuka
            expandedRowKey = e.key;
        }

        function onRowCollapsedHandler(e) {
            if (expandedRowKey === e.key) {
                expandedRowKey = null;
            }
        }

        function petugasCellTemplate(cellElement, cellInfo) {
            const nama = cellInfo.value ?? "-";
            const tahun = cellInfo.data.Tahun;
            const bulan = cellInfo.data.Bulan;
            const kegiatan = cellInfo.data.NamaKegiatan;

            const $link = $('<a>')
                .addClass('value-link text-decoration-none text-primary')
                .attr('href', 'javascript:void(0);')
                .attr('title', 'Lihat Detail Petugas')
                .text(nama)
                .on('click', () => {
                    openDetailRekap(kegiatan, tahun, bulan, nama); // Fungsi pemanggil modal
                });

            const $wrapper = $('<div>')
                .css({
                    display: 'flex',
                    alignItems: 'center',
                    justifyContent: 'flex-start'
                })
                .append($link);

            $(cellElement).append($wrapper);
        }


        function openDetailRekap(namaKegiatan, tahun, bulan, petugas) {
            const $modal = $("#staticBackdropExtraLargeScrollableCenter");

            $.ajax({
                url: '/PendataanReklame/DetailRekap',
                type: 'GET',
                data: {
                    namaKegiatan: namaKegiatan,
                    tahun: tahun,
                    bulan: bulan,
                    petugas: petugas
                },
                success: function (response) {
                    $modal.find(".modal-body").html(response);
                    $modal.modal('show');
                },
                error: function (xhr) {
                    console.error("Gagal memuat detail:", xhr.responseText);
                    Swal.fire("Error", "Gagal memuat data detail rekap", "error");
                }
            });
        }

    </script>
}