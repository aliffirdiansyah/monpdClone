@using System.Text.Json
@model MonPDReborn.Models.CCTVParkir.MonitoringCCTVVM.KapasitasHarianDetail

<style>
    /* Hilangkan padding top modal body supaya card nempel */
    #staticBackdropLargeScrollable .modal-body {
        padding-top: 0 !important;
    }
    
    /* Fixed Header khusus untuk Bootstrap modal-dialog-scrollable */
    .detail-fixed-header {
        position: sticky;
        position: -webkit-sticky; /* Safari support */
        top: 0;
        z-index: 1000;
        background: #ffffff;
        /* margin-top: 1rem;  */
        padding: 1rem 1rem 0.5rem 1rem;
        transition: box-shadow 0.3s ease;
    }
    
    .detail-fixed-header.scrolled {
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    /* Info Card di Header - lebih compact & stylish */
    .info-header-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 10px;
        padding: 1.25rem;
        color: white;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
    }

    .info-header-card .info-row {
        /* Kembalikan ke default/blok agar text-align berfungsi */
        /* Hapus display: flex yang kaku */
        margin-bottom: 0.6rem; 
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .info-header-card .info-row:last-child {
        margin-bottom: 0;
    }
    
    .info-header-card .info-label {
        font-weight: 600;
        opacity: 0.9;
        /* Hapus min-width */
    }

    .info-header-card .info-row-right {
        text-align: right; /* untuk desktop */
    }
    /* Responsive adjustments */

    @@media (max-width: 768px) {
    .info-header-card {
        padding: 1rem;
    }

    .info-header-card .info-row {
        display: flex;
        flex-direction: row; /* label & value dalam 1 baris */
        justify-content: flex-start; /* rata kiri */
        font-size: 0.85rem;
        margin-bottom: 0.5rem; /* jarak antar baris */
    }

    .info-header-card .info-label {
        font-weight: 600;
        margin-right: 0.5rem; /* jarak setelah titik : */
        min-width: 120px; /* sesuaikan supaya semua label punya lebar sama */
    }

    .info-header-card .info-value {
        font-weight: 400;
        overflow-wrap: anywhere; /* biar value panjang tidak pecah layout */
    }
</style>

<!-- FIXED HEADER -->
<div class="detail-fixed-header mb-2" id="detailFixedHeader">
    <div class="info-header-card mb-2">
        <div class="row"> 
            
            <div class="col-md-6 d-flex flex-column align-items-md-start">
                <div class="info-row">
                    <span class="info-label">Nama OP :</span>
                    <span class="info-value">@Model.NamaOP</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Alamat OP :</span>
                    <span class="info-value">@Model.AlamatOP</span>
                </div>
            </div>

            <div class="col-md-6 d-flex flex-column align-items-md-end">
                <div class="info-row">
                    <span class="info-label">NOP :</span>
                    <span class="info-value">@Model.formattedNop</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Vendor / Tanggal CCTV :</span>
                    <span class="info-value">@Model.Vendor / @Model.TanggalCctv</span>
                </div>
            </div>
            
        </div>
    </div>
</div>

<!-- SCROLLABLE CONTENT -->
<div class="detail-content-area">
    <div class="row">

        <!-- Chart Section -->
        <div class="col-lg-12 p-0">
            <div class="card p-0">
                <div class="card-body">
                    <h5 class="dxrd-text-align-left">Monitoring Kendaraan & Status CCTV (Auto Highlight)</h5>
                    <div id="line_chart_annotations" class="apex-charts" dir="ltr"></div>
                </div>
            </div>
        </div>
        
        <!-- DataGrid Section -->
        <div class="col-lg-12">
            <div class="card">
                <div class="card-body">
                    <div class="table-responsive">
                        @(Html.DevExtreme().DataGrid<MonPDReborn.Models.CCTVParkir.MonitoringCCTVVM.MonitoringCctvHarianDetail>()
                            .ID("gridDetailHarian")
                            .DataSource(Model.DataMonitoringDetail.OrderBy(x => x.TanggalMasuk).ToList())
                            .ShowBorders(true)
                            .ColumnAutoWidth(true)
                            .Sorting(s => s.Mode(GridSortingMode.None)) 
                            .HeaderFilter(h => h.Visible(true))
                            .Export(e => e.Enabled(true).Formats(new[] { "xlsx", "pdf" }))
                            .Paging(p => p.Enabled(false)) 
                            .Pager(p => p.Visible(false))
                            .OnExporting("exportGrid")
                            .OnRowPrepared("applyRowColor") 
                            .Columns(columns => {
                                columns.AddFor(m => m.TanggalMasuk).Caption("Waktu Masuk").DataType(GridColumnDataType.DateTime).Format("HH:mm:ss").Alignment(HorizontalAlignment.Center);
                                columns.AddFor(m => m.JenisKend).Caption("Jenis Kendaraan").Alignment(HorizontalAlignment.Center);
                                columns.AddFor(m => m.IsLogText).Caption("Event").Alignment(HorizontalAlignment.Center);
                                columns.AddFor(m => m.PlatNo).Caption("Plat Nomor").Alignment(HorizontalAlignment.Center);
                                columns.AddFor(m => m.Direction).Caption("Direction").Alignment(HorizontalAlignment.Center);
                                columns.Add().Caption("Lampiran").Alignment(HorizontalAlignment.Center).CellTemplate(new JS("lampiranCellTemplate"));
                            })
                        )
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    var masterKendaraan = @(Html.Raw(JsonSerializer.Serialize(Model.KapasitasChartDetail.MasterKendaraans)));
    var kendaraanData = @(Html.Raw(JsonSerializer.Serialize(Model.KapasitasChartDetail.KendaraanDatas)));
    var cctvEvents = @(Html.Raw(JsonSerializer.Serialize(Model.KapasitasChartDetail.CctvEvents)));

    // Waktu awal & akhir
    var startTime = new Date(kendaraanData[0].Waktu).getTime();
    var endTime = new Date(kendaraanData[kendaraanData.length - 1].Waktu).getTime();

    // === ANNOTATIONS CCTV ===
    var rangeAnnotations = [];
    if (cctvEvents.length === 0) {
        rangeAnnotations.push({
            x: startTime,
            x2: endTime,
            fillColor: '#51d28c',
            opacity: 0.15,
            label: {
                text: 'CCTV ON',
                borderColor: '#51d28c',
                style: { color: '#fff', background: '#51d28c' }
            }
        });
    } else {
        for (let i = 0; i < cctvEvents.length; i++) {
            var curr = cctvEvents[i];
            var next = cctvEvents[i + 1];
            var currTime = new Date(curr.Time).getTime();
            var nextTime = next ? new Date(next.Time).getTime() : endTime;

            rangeAnnotations.push({
                x: currTime,
                x2: nextTime,
                fillColor: curr.Status === "OFF" ? '#f34e4e' : '#51d28c',
                opacity: 0.15,
                label: {
                    text: `CCTV ${curr.Status}`,
                    borderColor: curr.Status === "OFF" ? '#f34e4e' : '#51d28c',
                    style: { color: '#fff', background: curr.Status === "OFF" ? '#f34e4e' : '#51d28c' }
                }
            });
        }

        if (new Date(cctvEvents[0].Time).getTime() > startTime) {
            rangeAnnotations.unshift({
                x: startTime,
                x2: new Date(cctvEvents[0].Time).getTime(),
                fillColor: cctvEvents[0].Status === "OFF" ? '#51d28c' : '#f34e4e',
                opacity: 0.15,
                label: {
                    text: `CCTV ${cctvEvents[0].Status === "OFF" ? "ON" : "OFF"}`,
                    borderColor: cctvEvents[0].Status === "OFF" ? '#51d28c' : '#f34e4e',
                    style: { color: '#fff', background: cctvEvents[0].Status === "OFF" ? '#51d28c' : '#f34e4e' }
                }
            });
        }
    }

    // === GENERATE SERIES ===
    var chartSeries = masterKendaraan.map(k => ({
        name: k.Name.charAt(0).toUpperCase() + k.Name.slice(1),
        data: kendaraanData.map(d => {
            var found = d.Jenis.find(j => j.Name === k.Name);
            return { x: new Date(d.Waktu).getTime(), y: found ? found.Value : 0 };
        }),
        color: k.Color
    }));

    // === CHART CONFIG ===
    var options = {
        series: chartSeries,
        chart: { height: 350, type: 'line', toolbar: { show: true , offsetX: -5,offsetY: 35, } },
        stroke: { curve: 'smooth' },
        xaxis: { type: 'datetime', title: { text: 'Akumulasi (per 15 menit)' }, labels: { datetimeUTC: false } },
        yaxis: { title: { text: 'Jumlah Kendaraan' } },
        annotations: { xaxis: rangeAnnotations },
        // title: { text: 'Monitoring Kendaraan & Status CCTV (Auto Highlight)',  align: 'left', style: { fontWeight: 400 } },
        tooltip: { x: { format: 'HH:mm' } },
        markers: { size: 0 }
    };

    var chart = new ApexCharts(document.querySelector("#line_chart_annotations"), options);
    chart.render();

    // === SCROLL EFFECT - Langsung target modal-body ===
    $(document).ready(function() {
        // Target langsung modal body dari Bootstrap modal-dialog-scrollable
        var $modalBody = $('#staticBackdropLargeScrollable .modal-body');
        
        $modalBody.on('scroll', function() {
            var scrollTop = $(this).scrollTop();
            
            if (scrollTop > 20) {
                $('#detailFixedHeader').addClass('scrolled');
            } else {
                $('#detailFixedHeader').removeClass('scrolled');
            }
        });
        
        // Cleanup saat modal ditutup
        $('#staticBackdropLargeScrollable').on('hidden.bs.modal', function() {
            $('#detailFixedHeader').removeClass('scrolled');
        });
    });
</script>