@using MonPDLib.General
@using System.Text.Json
@model MonPDReborn.Models.CCTVParkir.MonitoringCCTVVM.LiveStreamingCounting



<div class="card-body">
    <h5 class="card-title mb-4">
        <i class="ri-video-line me-2 text-primary"></i>Analysis Result
    </h5>


    <div class="row text-center mb-4">
        <div class="col-md-4 mb-3">
            <div class="p-3 border rounded">
                <i class="ri-car-line fs-2 text-primary mb-2"></i>
                <h6 class="text-muted mb-1">Mobil Masuk</h6>
                <h3 class="fw-bold text-primary">@Model.AnalysisResult.Mobil</h3>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="p-3 border rounded">
                <i class="ri-motorbike-line fs-2 text-success mb-2"></i>
                <h6 class="text-muted mb-1">Motor Masuk</h6>
                <h3 class="fw-bold text-success">@Model.AnalysisResult.Motor</h3>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="p-3 border rounded">
                <i class="ri-question-line fs-2 text-warning mb-2"></i>
                <h6 class="text-muted mb-1">Unknown</h6>
                <h3 class="fw-bold text-warning">@Model.AnalysisResult.Unknown</h3>
            </div>
        </div>
    </div>


    <div class="border-top mt-4 pt-3">
        <h5 class="fw-bold mb-3">
            <i class="ri-coins-line me-2 text-success"></i>Data Pajak
        </h5>

        <div class="row text-center">
            <div class="col-md-4 mb-3">
                <div class="p-3 border rounded bg-light">
                    <h6 class="text-muted mb-1">
                        <i class="ri-line-chart-line text-info me-1"></i>Estimasi Pajak
                    </h6>
                    <h4 class="fw-bold text-success mb-0">Rp @Model.AnalysisResult.EstimasiPajak.ToString("N0")</h4>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="p-3 border rounded bg-light">
                    <h6 class="text-muted mb-1">
                        <i class="ri-calendar-2-line text-secondary me-1"></i>Realisasi 2024
                    </h6>
                    <h4 class="fw-bold text-secondary mb-0">Rp @Model.AnalysisResult.TahunKemarin.ToString("N0")</h4>
                </div>
            </div>
            <div class="col-md-4 mb-3">
                <div class="p-3 border rounded bg-light">
                    <h6 class="text-muted mb-1">
                        <i class="ri-calendar-check-line text-primary me-1"></i>Realisasi 2025
                    </h6>
                    <h4 class="fw-bold text-primary mb-0">Rp @Model.AnalysisResult.TahunIni.ToString("N0")</h4>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="col-lg-12 p-0">
            <div class="card p-0">
                <div class="card-body">
                    <div id="line_chart_annotations" class="apex-charts" dir="ltr"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="border-top mt-3 pt-3">
        <h6 class="fw-bold mb-2">
            <i class="ri-line-chart-line me-2 text-info"></i>Detail Tambahan
        </h6>
        <ul class="list-unstyled mb-0">
            <li><i class="ri-bar-chart-line me-2 text-secondary"></i>Waktu tersibuk: <strong>@Model.AnalysisResult.WaktuTersibuk</strong></li>
            <li><i class="ri-roadster-line me-2 text-primary"></i>Rata-rata mobil per jam: <strong>@Model.AnalysisResult.RatarataMobil</strong></li>
            <li><i class="ri-run-line me-2 text-success"></i>Rata-rata motor per jam: <strong>@Model.AnalysisResult.RatarataMotor</strong></li>
            <li><i class="ri-time-line me-2 text-muted"></i>Data terakhir diperbarui: <strong>@Model.AnalysisResult.LastUpdate</strong></li>
        </ul>
    </div>
</div>


<script>
    var masterKendaraan = @(Html.Raw(JsonSerializer.Serialize(Model.KapasitasChartDetail.MasterKendaraans)));
    var kendaraanData = @(Html.Raw(JsonSerializer.Serialize(Model.KapasitasChartDetail.KendaraanDatas)));
    var cctvEvents = @(Html.Raw(JsonSerializer.Serialize(Model.KapasitasChartDetail.CctvEvents)));

    // Waktu awal & akhir
    var startTime = new Date(kendaraanData[0].Waktu).getTime();
    var endTime = new Date(kendaraanData[kendaraanData.length - 1].Waktu).getTime();

    // === ANNOTATIONS CCTV ===
    var rangeAnnotations = [];
    if (cctvEvents.length === 0) {
        rangeAnnotations.push({
            x: startTime,
            x2: endTime,
            fillColor: '#51d28c',
            opacity: 0.15,
            label: {
                text: 'CCTV ON',
                borderColor: '#51d28c',
                style: { color: '#fff', background: '#51d28c' }
            }
        });
    } else {
        for (let i = 0; i < cctvEvents.length; i++) {
            var curr = cctvEvents[i];
            var next = cctvEvents[i + 1];
            var currTime = new Date(curr.Time).getTime();
            var nextTime = next ? new Date(next.Time).getTime() : endTime;

            rangeAnnotations.push({
                x: currTime,
                x2: nextTime,
                fillColor: curr.Status === "OFF" ? '#f34e4e' : '#51d28c',
                opacity: 0.15,
                label: {
                    text: `CCTV ${curr.Status}`,
                    borderColor: curr.Status === "OFF" ? '#f34e4e' : '#51d28c',
                    style: { color: '#fff', background: curr.Status === "OFF" ? '#f34e4e' : '#51d28c' }
                }
            });
        }

        if (new Date(cctvEvents[0].Time).getTime() > startTime) {
            rangeAnnotations.unshift({
                x: startTime,
                x2: new Date(cctvEvents[0].Time).getTime(),
                fillColor: cctvEvents[0].Status === "OFF" ? '#51d28c' : '#f34e4e',
                opacity: 0.15,
                label: {
                    text: `CCTV ${cctvEvents[0].Status === "OFF" ? "ON" : "OFF"}`,
                    borderColor: cctvEvents[0].Status === "OFF" ? '#51d28c' : '#f34e4e',
                    style: { color: '#fff', background: cctvEvents[0].Status === "OFF" ? '#51d28c' : '#f34e4e' }
                }
            });
        }
    }

    // === GENERATE SERIES ===
    var chartSeries = masterKendaraan.map(k => ({
        name: k.Name.charAt(0).toUpperCase() + k.Name.slice(1),
        data: kendaraanData.map(d => {
            var found = d.Jenis.find(j => j.Name === k.Name);
            return { x: new Date(d.Waktu).getTime(), y: found ? found.Value : 0 };
        }),
        color: k.Color
    }));

    // === CHART CONFIG ===
    var options = {
        series: chartSeries,
        chart: { height: 350, type: 'line', toolbar: { show: true } },
        stroke: { curve: 'smooth' },
        xaxis: { type: 'datetime', title: { text: 'Akumulasi (per 15 menit)' }, labels: { datetimeUTC: false } },
        yaxis: { title: { text: 'Jumlah Kendaraan' } },
        annotations: { xaxis: rangeAnnotations },
        title: { text: 'Monitoring Kendaraan & Status CCTV (Auto Highlight)', align: 'left', style: { fontWeight: 600 } },
        tooltip: { x: { format: 'HH:mm' } },
        markers: { size: 0 }
    };

    var chart = new ApexCharts(document.querySelector("#line_chart_annotations"), options);
    chart.render();

    // === SCROLL EFFECT - Langsung target modal-body ===
    $(document).ready(function() {
        // Target langsung modal body dari Bootstrap modal-dialog-scrollable
        var $modalBody = $('#staticBackdropLargeScrollable .modal-body');

        $modalBody.on('scroll', function() {
            var scrollTop = $(this).scrollTop();

            if (scrollTop > 20) {
                $('#detailFixedHeader').addClass('scrolled');
            } else {
                $('#detailFixedHeader').removeClass('scrolled');
            }
        });

        // Cleanup saat modal ditutup
        $('#staticBackdropLargeScrollable').on('hidden.bs.modal', function() {
            $('#detailFixedHeader').removeClass('scrolled');
        });
    });
</script>