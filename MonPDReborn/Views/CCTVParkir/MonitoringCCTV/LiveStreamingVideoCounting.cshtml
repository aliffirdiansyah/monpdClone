@using MonPDLib.General
@using System.Text.Json
@model MonPDReborn.Models.CCTVParkir.MonitoringCCTVVM.LiveStreamingCounting



<div class="card-body">
    <h5 class="card-title mb-3">
        <i class="ri-video-line me-2 text-primary"></i>Analysis Result
    </h5>


    <div class="row text-center mb-4">
        <div class="col-md-6 mb-3">
            <div class="p-3 border rounded">
                <i class="ri-car-line fs-2 text-primary mb-2"></i>
                <h6 class="text-muted mb-1">Mobil Masuk</h6>
                <h3 id="mobilMasuk" class="fw-bold text-primary">@Model.AnalysisResult.Mobil</h3>
            </div>
        </div>
        <div class="col-md-6 mb-3">
            <div class="p-3 border rounded">
                <i class="ri-motorbike-line fs-2 text-success mb-2"></i>
                <h6 class="text-muted mb-1">Motor Masuk</h6>
                <h3 id="motorMasuk" class="fw-bold text-success">@Model.AnalysisResult.Motor</h3>
            </div>
        </div>
        <!-- ### JANGAN DIHAPUS ###-->
        @* <div class="col-md-4 mb-3">
            <div class="p-3 border rounded">
                <i class="ri-question-line fs-2 text-warning mb-2"></i>
                <h6 class="text-muted mb-1">Unknown</h6>
                <h3 class="fw-bold text-warning">@Model.AnalysisResult.Unknown</h3>
            </div>
        </div> *@
    </div>


    <div class="border-top mt-4 pt-3">
        <h5 class="card-title mb-3">
            <i class="ri-coins-line me-2 text-success"></i>Data Pajak
        </h5>

        <div class="row text-center">
            <div class="col-md-4 mb-3" title="Cek Detail Estimasi">
                <a href="/MonitoringCCTV/Kapasitas?nop=@Model.Nop&vendorId=@Model.VendorId" style="cursor: pointer">
                    <div class="p-3 border rounded bg-light">
                        <h6 class="text-muted mb-1">
                            <i class="ri-line-chart-line text-info me-1"></i>Estimasi Pajak 
                        </h6>
                        <h6 class="text-muted mb-1">
                            Bulan @Model.AnalysisResult.bulanIni
                        </h6>
                        <h4 class="fw-bold text-success mb-0">Rp @Model.AnalysisResult.EstimasiPajak.ToString("N0")</h4>
                    </div>
                </a>
            </div>
          
            <div class="col-md-4 mb-3">
                <div class="p-3 border rounded bg-light">
                    <h6 class="text-muted mb-1">
                        <i class="ri-calendar-2-line text-secondary me-1"></i>Realisasi 2024
                    </h6>
                    <h6 class="text-muted mb-1">
                        Bulan @Model.AnalysisResult.bulanIni
                    </h6>
                    <h4 class="fw-bold text-secondary mb-0">Rp @Model.AnalysisResult.TahunKemarin.ToString("N0")</h4>
                </div>
            </div>

            <div class="col-md-4 mb-3">
                <div class="p-3 border rounded bg-light">
                    <h6 class="text-muted mb-1">
                        <i class="ri-calendar-check-line text-primary me-1"></i>Realisasi 2025
                    </h6>
                    <h6 class="text-muted mb-1">
                        Bulan @Model.AnalysisResult.bulanLalu
                    </h6>
                    <h4 class="fw-bold text-primary mb-0">Rp @Model.AnalysisResult.TahunIni.ToString("N0")</h4>
                </div>
            </div>
        </div>

        <!-- Chart Section -->
        <div class="col-lg-12 p-0">
            <div class="card p-0">
                <div class="card-body">
                    <h5 class="dxrd-text-align-left">Monitoring Kendaraan & Status CCTV (Auto Highlight)</h5>
                    <div id="line_chart_annotations" class="apex-charts" dir="ltr"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="border-top mt-3 pt-3">
        <h6 class="fw-bold mb-2">
            <i class="ri-line-chart-line me-2 text-info"></i>Detail Tambahan
        </h6>
        <ul class="list-unstyled mb-0">
            <li><i class="ri-bar-chart-line me-2 text-secondary"></i>Waktu tersibuk: <strong>@Model.AnalysisResult.WaktuTersibukLabel</strong></li>
            <li><i class="ri-roadster-line me-2 text-primary"></i>Rata-rata mobil per jam: <strong>@Model.AnalysisResult.RatarataMobil</strong></li>
            <li><i class="ri-motorbike-line me-2 text-success"></i>Rata-rata motor per jam: <strong>@Model.AnalysisResult.RatarataMotor</strong></li>
            <li><i class="ri-time-line me-2 text-muted"></i>Data terakhir diperbarui: <strong id="lastUpdate">@Model.AnalysisResult.LastUpdate</strong></li>
        </ul>
    </div>
</div>


<script>
    // 1. Deklarasi Variabel Global untuk Akses oleh updateChart
    // Menggunakan window. untuk memastikan variabel dapat diakses secara global
    window.masterKendaraan = @(Html.Raw(JsonSerializer.Serialize(Model.KapasitasChartDetail.MasterKendaraans)));

    // Variabel lokal untuk inisialisasi awal (tidak perlu diubah ke window, karena hanya dipakai di inisialisasi)
    var kendaraanData = @(Html.Raw(JsonSerializer.Serialize(Model.KapasitasChartDetail.KendaraanDatas)));
    var cctvEvents = @(Html.Raw(JsonSerializer.Serialize(Model.KapasitasChartDetail.CctvEvents)));

    // Waktu awal & akhir (juga lokal untuk inisialisasi)
    var startTime = kendaraanData.length > 0 ? new Date(kendaraanData[0].Waktu).getTime() : Date.now();
    var endTime = kendaraanData.length > 0 ? new Date(kendaraanData[kendaraanData.length - 1].Waktu).getTime() : Date.now();

    // ----------------------------------------------------
    // HELPER FUNCTION: Menghasilkan Anotasi Chart (dapat di-re-use)
    // ----------------------------------------------------
    function generateChartAnnotations(events, dataPoints, startTs, endTs) {
        if (!dataPoints || dataPoints.length === 0) {
            // Jika tidak ada data kendaraan, atur rentang ke default CCTV ON
            return [{
                x: startTs || Date.now() - 3600000,
                x2: endTs || Date.now(),
                fillColor: '#51d28c', opacity: 0.15,
                label: { text: 'CCTV ON', borderColor: '#51d28c', style: { color: '#fff', background: '#51d28c' } }
            }];
        }

        const annotations = [];
        const finalEndTime = endTs || new Date(dataPoints[dataPoints.length - 1].Waktu).getTime();

        if (events.length === 0) {
            // Kasus: Tidak ada log event, asumsikan ON sepanjang data tersedia
            annotations.push({
                x: startTs, x2: finalEndTime, fillColor: '#51d28c', opacity: 0.15,
                label: { text: 'CCTV ON', borderColor: '#51d28c', style: { color: '#fff', background: '#51d28c' } }
            });
        } else {
            for (let i = 0; i < events.length; i++) {
                var curr = events[i];
                var next = events[i + 1];
                var currTime = new Date(curr.Time || curr.time).getTime();
                var nextTime = next ? new Date(next.Time || next.time).getTime() : finalEndTime;

                annotations.push({
                    x: currTime, x2: nextTime,
                    fillColor: curr.Status === "OFF" ? '#f34e4e' : '#51d28c',
                    opacity: 0.15,
                    label: {
                        text: `CCTV ${curr.Status}`,
                        borderColor: curr.Status === "OFF" ? '#f34e4e' : '#51d28c',
                        style: { color: '#fff', background: curr.Status === "OFF" ? '#f34e4e' : '#51d28c' }
                    }
                });
            }

            // Menangani celah dari startTime ke event pertama
            if (new Date(events[0].Time || events[0].time).getTime() > startTs) {
                annotations.unshift({
                    x: startTs,
                    x2: new Date(events[0].Time || events[0].time).getTime(),
                    fillColor: events[0].Status === "OFF" ? '#51d28c' : '#f34e4e',
                    opacity: 0.15,
                    label: {
                        text: `CCTV ${events[0].Status === "OFF" ? "ON" : "OFF"}`,
                        borderColor: events[0].Status === "OFF" ? '#51d28c' : '#f34e4e',
                        style: { color: '#fff', background: events[0].Status === "OFF" ? '#51d28c' : '#f34e4e' }
                    }
                });
            }
        }
        return annotations;
    }

    // ----------------------------------------------------
    // INIIALISASI AWAL CHART
    // ----------------------------------------------------

    // Generate Annotations awal
    var rangeAnnotations = generateChartAnnotations(cctvEvents, kendaraanData, startTime, endTime);

    // Generate Series awal
    var chartSeries = window.masterKendaraan.map(k => ({
        name: k.Name.charAt(0).toUpperCase() + k.Name.slice(1),
        data: kendaraanData.map(d => {
            var found = d.Jenis.find(j => j.Name === k.Name);
            return { x: new Date(d.Waktu).getTime(), y: found ? found.Value : 0 };
        }),
        color: k.Color
    }));

    // Chart Config
    var options = {
        series: chartSeries,
        chart: { height: 350, type: 'line', toolbar: { show: true , offsetX: -5,offsetY: 55, } },
        stroke: { curve: 'smooth' },
        xaxis: { type: 'datetime', title: { text: 'Akumulasi (per 15 menit)' }, labels: { datetimeUTC: false } },
        yaxis: { title: { text: 'Jumlah Kendaraan' } },
        annotations: { xaxis: rangeAnnotations },
        tooltip: { x: { format: 'HH:mm' } },
        markers: { size: 0 }
    };

    // Inisialisasi Instance Chart Global
    window.chartInstance = new ApexCharts(document.querySelector("#line_chart_annotations"), options);
    window.chartInstance.render();

    // ----------------------------------------------------
    // FUNGSI GLOBAL UPDATE DARI SSE (HANYA FOKUS KE CHART)
    // ----------------------------------------------------

    window.updateChart = function (newData) {
        if (!newData) {
            console.warn("⚠️ newData kosong, tidak bisa update chart");
            return;
        }

        // ❌ HILANGKAN SEMUA LOGIKA PEMBARUAN CARD DI SINI
        // Karena sudah ditangani oleh updateAnalysisUI di parent view

        // 🔹 Pastikan semua elemen penting ada
        // Ambil properti utama, fokus pada casing yang dikirim oleh Controller (camelCase)
        const detail = newData.kapasitasChartDetail || newData.KapasitasChartDetail; // Pastikan salah satu didapat

        // Ambil array data, fokus pada casing yang dikirim oleh Controller (camelCase)
        const dataKendaraan = detail?.kendaraanDatas || detail?.KendaraanDatas;

        // 🔹 Validasi yang Diperbaiki
        if (!detail || !dataKendaraan || !window.masterKendaraan || !window.chartInstance) {
            console.warn("⚠️ Struktur data chart tidak lengkap atau chartInstance belum siap");
            console.log({
                detailAda: !!detail,
                dataKendaraanAda: !!dataKendaraan,
                masterKendaraan: !!window.masterKendaraan,
                chartInstance: !!window.chartInstance
            });
            return;
        }

        // 🔹 Normalisasi data Kendaraan Datas (mengantisipasi casing JSON)
        const kendaraanDatas = (detail.KendaraanDatas || detail.kendaraanDatas).map(d => ({
            waktu: d.Waktu || d.waktu,
            jenis: (d.Jenis || d.jenis || []).map(j => ({
                name: j.Name || j.name,
                value: j.Value ?? j.value ?? 0
            }))
        }));

        // 🔹 Update data series (Mapping ulang data berdasarkan masterKendaraan)
        const updatedSeries = window.masterKendaraan.map(k => {
            const seriesName = (k.Name || k.name || "Unknown").charAt(0).toUpperCase() + (k.Name || k.name || "").slice(1);
            const seriesColor = k.Color || k.color || undefined;
            const seriesData = kendaraanDatas.map(d => {
                const found = d.jenis.find(j => j.name === (k.Name || k.name));
                return { x: new Date(d.waktu).getTime(), y: found ? found.value : 0 };
            });

            return {
                name: seriesName,
                data: seriesData,
                color: seriesColor
            };
        });

        // 🔹 Perbarui Anotasi (CCTV Status)
        const newCctvEvents = detail.CctvEvents || detail.cctvEvents || [];
        const latestTime = kendaraanDatas[kendaraanDatas.length - 1].waktu;
        const latestTs = new Date(latestTime).getTime();
        const firstTime = kendaraanDatas[0].waktu;
        const firstTs = new Date(firstTime).getTime();

        const updatedRangeAnnotations = generateChartAnnotations(
            newCctvEvents,
            kendaraanDatas,
            firstTs,
            latestTs
        );

        // 🔹 Panggil API update chart ApexCharts
        try {
            // Update Series
            window.chartInstance.updateSeries(updatedSeries);

            // Update Options (hanya Anotasi yang berubah)
            window.chartInstance.updateOptions({
                annotations: {
                    xaxis: updatedRangeAnnotations
                }
            }, false, true); // (options, redrawPaths = false, animate = true)

            // console.log("📈 Chart & Annotations Updated:", new Date().toLocaleTimeString());
        } catch (err) {
            console.error("❌ Gagal update chart:", err);
        }
    };

     // === SCROLL EFFECT - Langsung target modal-body ===
    $(document).ready(function() {
        // Target langsung modal body dari Bootstrap modal-dialog-scrollable
        var $modalBody = $('#staticBackdropLargeScrollable .modal-body');

        $modalBody.on('scroll', function() {
            var scrollTop = $(this).scrollTop();

            if (scrollTop > 20) {
                $('#detailFixedHeader').addClass('scrolled');
            } else {
                $('#detailFixedHeader').removeClass('scrolled');
            }
        });

        // Cleanup saat modal ditutup
        $('#staticBackdropLargeScrollable').on('hidden.bs.modal', function() {
            $('#detailFixedHeader').removeClass('scrolled');
        });
    });

</script>
