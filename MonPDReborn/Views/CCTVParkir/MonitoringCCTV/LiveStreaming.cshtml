@model MonPDReborn.Models.CCTVParkir.MonitoringCCTVVM.LiveStreaming
@{
    ViewBag.Title = "Live Camera";

    string nop = Model.Nop;
    string cctvId = Model.CctvIdList.FirstOrDefault()?.Value ?? "0";
}

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-body">
                <p>op: @(Model.NamaOP) - @(Model.formattedNop)</p>
                <p>alamat: @(Model.AlamatOP)</p>
                <p>vendor: @(Model.Vendor)</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="text-center">
            <div id="loading2-LiveStreamingVideo" class="spinner-border text-primary" style="display: none">
                <span class="visually-hidden">Loading...</span>
            </div>
        </div>
        <div id="LiveStreamingVideo" class="mt-3"></div>
    </div>

    <div class="col-lg-4">
    </div>
</div>


@section Scripts {
    <script>

        $(document).ready(function () {
            loadLiveStreamingVideo();
        });

        function loadLiveStreamingVideo() {
            $("#loading2-LiveStreamingVideo").show();

            var nop = '@(nop)';
            var cctvId = '@(cctvId)';

            $.ajax({
                url: '@(Url.Action("LiveStreamingVideo"))',
                type: 'GET',
                data: { nop, cctvId  }, // kalau null berarti semua uptb
                success: function (result) {
                    $("#LiveStreamingVideo").html(result);
                },
                error: function () {
                    $("#LiveStreamingVideo").html("<div class='text-danger'>Gagal memuat data.</div>");
                },
                complete: function () {
                    $("#loading2-LiveStreamingVideo").hide();
                }
            });
        }
    </script>

    <script>
        async function startWebRTC(videoElementId, sourceUrl) {
            const videoElement = document.getElementById(videoElementId);
            if (!videoElement) {
                console.error(`Element dengan id '${videoElementId}' tidak ditemukan`);
                return;
            }

            const pc = new RTCPeerConnection({
                iceServers: [
                    { urls: ["stun:stun.l.google.com:19302"] } // optional
                ]
            });

            pc.ontrack = (event) => {
                console.log("Track diterima dari:", sourceUrl);
                videoElement.srcObject = event.streams[0];
            };

            pc.addTransceiver("video", { direction: "recvonly" });
            pc.addTransceiver("audio", { direction: "recvonly" });

            try {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                const res = await fetch(sourceUrl, {
                    method: "POST",
                    body: offer.sdp,
                    headers: { "Content-Type": "application/sdp" }
                });

                const answer = await res.text();
                await pc.setRemoteDescription({ type: "answer", sdp: answer });

                console.log(`✅ WebRTC connected: ${sourceUrl}`);
            } catch (err) {
                console.error(`❌ WebRTC error (${sourceUrl}):`, err);
            }
        }
    </script>
}