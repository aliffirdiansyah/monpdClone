@model MonPDReborn.Models.CCTVParkir.MonitoringCCTVVM.LiveStreaming
@{
    ViewBag.Title = "Live Camera";

    string nop = Model.Nop;
    string cctvId = Model.CctvIdList.FirstOrDefault()?.Value ?? "0";
}

<style>

    .profile-wid-bg::before {
        content: "";
        position: absolute;
        right: 0;
        left: 0;
        top: 0;
        bottom: 0;
        opacity: 0.8;
        background-image: linear-gradient(to left, #299cdb 25%,#0ab39c);
    }

    .profile-wid-bg .profile-wid-img {
        width: 100%;
        height: 100%;
        -o-object-fit: cover;
        object-fit:  cover;
    }
</style>


<div class="profile-foreground position-relative mx-n4 mt-n4">
    <div class="profile-wid-bg">
        <img src="~/assets/images/image-cover.jpeg" alt="" class="profile-wid-img" />
    </div>
</div>
<div class="pt-4 mb-4 mb-lg-3 pb-lg-4">
    <div class="row g-4 align-items-center justify-content-between">

        <div class="col-lg-8 col-md-12">
            <div class="p-2">
                <!-- Nama OP -->
                <h3 class="text-white mb-1">@Model.NamaOP</h3>

                <!-- NOP -->
                <p class="text-white-75 mb-2">@Model.formattedNop</p>

                <!-- Info bar -->
                <div class="hstack text-white-50 gap-3 flex-wrap">
                    <!-- Alamat lengkap -->
                    <div>
                        <i class="ri-map-pin-user-line me-1 text-white-75 fs-16 align-middle"></i>
                        @* @Model.AlamatOP, @Model.Kecamatan, @Model.Kelurahan *@ alamat dan lain lain
                    </div>

                    <!-- UPTB -->
                    <div>
                        <i class="ri-building-line me-1 text-white-75 fs-16 align-middle"></i>
                        @* @Model.UptbId *@ uptbid
                    </div>

                    <!-- Vendor -->
                    <div>
                        <i class="ri-user-3-line me-1 text-white-75 fs-16 align-middle"></i>
                        Vendor:
                        <span class="text-white-75 fw-semibold">@Model.Vendor</span>
                    </div>
                </div>
            </div>
        </div>


        <div class="col-lg-auto col-md-12 text-lg-end text-center">
            <div class="p-2">
                <h4 id="currentTime" class="text-white mb-1 fw-semibold"></h4>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        <div>
            <div class="d-flex">

                <ul class="nav nav-pills animation-nav profile-nav gap-2 gap-lg-3 flex-grow-1"
                    role="tablist">
                    <li class="nav-item">
                        <a class="nav-link fs-14 active" data-bs-toggle="tab" href="#overview-tab"
                           role="tab">
                            <i class="ri-airplay-fill d-inline-block d-md-none"></i> <span class="d-none d-md-inline-block">Overview</span>
                        </a>
                    </li>
                </ul>
                <div class="flex-shrink-0">
                    <div class="dropdown">
                        <button class="btn btn-info dropdown-toggle" type="button" id="dropdownObjekPajak" data-bs-toggle="dropdown" aria-expanded="false">
                            Pilih Objek Pajak
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="dropdownObjekPajak">
                            <li><a class="dropdown-item" href="#">Op Parkir1</a></li>
                            <li><a class="dropdown-item" href="#">Op Parkir2</a></li>
                            <li><a class="dropdown-item" href="#">Op Parkir3</a></li>
                            <li><a class="dropdown-item" href="#">Op Parkir4</a></li>
                            <li><a class="dropdown-item" href="#">Op Parkir5</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <div class="tab-content pt-4 text-muted">
                <div class="tab-pane active" id="overview-tab" role="tabpanel">
                    <div class="row align-items-stretch">
                        <div class="col-xxl-7 d-flex flex-column">
                            <div class="card flex-fill">
                                <div class="card-body text-center">

                                    <div class="d-flex justify-content-center align-items-center gap-2 flex-wrap mb-3 px-2">
                                        <div class="input-group" style="max-width: 280px;">
                                            <label class="input-group-text" for="inputGroupSelect01">CCTV ID</label>
                                            <select class="form-select" id="inputGroupSelect01">
                                                <option value="1" selected>910 [AKTIF]</option>
                                                <option value="2">920 [TIDAK AKTIF]</option>
                                                <option value="3">930 [TIDAK AKTIF]</option>
                                            </select>
                                        </div>


                                        <span id="cctvStatusBadge" class="badge bg-success d-flex align-items-center py-2 px-3">
                                            <i class="ri-record-circle-line me-1"></i> CCTV: ON
                                        </span>
                                    </div>

                                    <div id="lastActiveInfo" class="text-muted small mb-3">
                                        <i class="ri-time-line me-1"></i>Terakhir aktif: <strong id="lastActiveDate">-</strong>
                                    </div>


                                    <div class="ratio ratio-16x9" style=" margin: 0 auto;">
                                        <video id="videoPreview" class="rounded border" autoplay muted playsinline>
                                            <source src="your-video.mp4" type="video/mp4">
                                            Browser kamu tidak mendukung tag video.
                                        </video>
                                    </div>
                                </div>
                            </div>

                            <div class="card flex-fill mt-3">
                                <div class="card-body">
                                    <h5 class="card-title mb-3">Info Detail</h5>
                                    <div class="table-responsive">
                                        <table class="table table-borderless mb-0">
                                            <tbody>
                                                <tr>
                                                    <th class="ps-0" scope="row">Objek Pajak :</th>
                                                    <td class="text-muted">[NamaOp] - [NOP]</td>
                                                </tr>
                                                <tr>
                                                    <th class="ps-0" scope="row">Alamat :</th>
                                                    <td class="text-muted">[Alamat],[Kec][Kel]</td>
                                                </tr>
                                                <tr>
                                                    <th class="ps-0" scope="row">Uptb :</th>
                                                    <td class="text-muted">UPTB [UPTB_ID]</td>
                                                </tr>
                                                <tr>
                                                    <th class="ps-0" scope="row">Tanggal Buka :</th>
                                                    <td class="text-muted">
                                                        [yyyy-MM-dd]
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th class="ps-0" scope="row" style="vertical-align: top;">Tarif</th>
                                                    <td colspan="2">
                                                        <table class="table table-sm mb-0">
                                                            <tbody>
                                                                <tr>
                                                                    <td class="text-muted">Roda Dua</td>
                                                                    <td class="text-muted text-end">2000</td>
                                                                </tr>
                                                                <tr>
                                                                    <td class="text-muted">Roda Empat</td>
                                                                    <td class="text-muted text-end">4000</td>
                                                                </tr>
                                                            </tbody>
                                                        </table>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xxl-5 d-flex">
                            <div class="card flex-fill">
                                <div class="card-body">
                                    <h5 class="card-title mb-4">
                                        <i class="ri-video-line me-2 text-primary"></i>Analysis Result
                                    </h5>


                                    <div class="row text-center mb-4">
                                        <div class="col-md-4 mb-3">
                                            <div class="p-3 border rounded">
                                                <i class="ri-car-line fs-2 text-primary mb-2"></i>
                                                <h6 class="text-muted mb-1">Mobil Masuk</h6>
                                                <h3 class="fw-bold text-primary">125</h3>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="p-3 border rounded">
                                                <i class="ri-motorbike-line fs-2 text-success mb-2"></i>
                                                <h6 class="text-muted mb-1">Motor Masuk</h6>
                                                <h3 class="fw-bold text-success">342</h3>
                                            </div>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <div class="p-3 border rounded">
                                                <i class="ri-question-line fs-2 text-warning mb-2"></i>
                                                <h6 class="text-muted mb-1">Unknown</h6>
                                                <h3 class="fw-bold text-warning">7</h3>
                                            </div>
                                        </div>
                                    </div>


                                    <div class="border-top mt-4 pt-3">
                                        <h6 class="fw-bold mb-3">
                                            <i class="ri-coins-line me-2 text-success"></i>Data Pajak
                                        </h6>

                                        <div class="row text-center">
                                            <div class="col-md-4 mb-3">
                                                <div class="p-3 border rounded bg-light">
                                                    <h6 class="text-muted mb-1">
                                                        <i class="ri-line-chart-line text-info me-1"></i>Estimasi Pajak
                                                    </h6>
                                                    <h4 class="fw-bold text-success mb-0">Rp 2.345.000</h4>
                                                </div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <div class="p-3 border rounded bg-light">
                                                    <h6 class="text-muted mb-1">
                                                        <i class="ri-calendar-2-line text-secondary me-1"></i>Realisasi 2024
                                                    </h6>
                                                    <h4 class="fw-bold text-secondary mb-0">Rp 1.980.000</h4>
                                                </div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <div class="p-3 border rounded bg-light">
                                                    <h6 class="text-muted mb-1">
                                                        <i class="ri-calendar-check-line text-primary me-1"></i>Realisasi 2025
                                                    </h6>
                                                    <h4 class="fw-bold text-primary mb-0">Rp 2.120.000</h4>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="grafikMonitoring"></div>
                                    </div>

                                    <div class="border-top mt-3 pt-3">
                                        <h6 class="fw-bold mb-2">
                                            <i class="ri-line-chart-line me-2 text-info"></i>Detail Tambahan
                                        </h6>
                                        <ul class="list-unstyled mb-0">
                                            <li><i class="ri-bar-chart-line me-2 text-secondary"></i>Waktu tersibuk: <strong>17:00 - 19:00</strong></li>
                                            <li><i class="ri-roadster-line me-2 text-primary"></i>Rata-rata mobil per jam: <strong>15</strong></li>
                                            <li><i class="ri-run-line me-2 text-success"></i>Rata-rata motor per jam: <strong>40</strong></li>
                                            <li><i class="ri-time-line me-2 text-muted"></i>Data terakhir diperbarui: <strong>04 Okt 2025 19:45</strong></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="card">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 me-2">Aktivitas</h4>
                                </div>

                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped table-bordered align-middle mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th scope="col">Tanggal Masuk</th>
                                                    <th scope="col">Jenis Kendaraan</th>
                                                    <th scope="col">Plat Nomor</th>
                                                    <th scope="col" class="text-center">Lampiran</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr>
                                                    <td>05 Okt 2025 08:15</td>
                                                    <td>Mobil</td>
                                                    <td>B 1234 XYZ</td>
                                                    <td class="text-center">
                                                        <img src="https://images.unsplash.com/photo-1502877338535-766e1452684a?w=100"
                                                             alt="Lampiran Mobil" class="rounded border" width="100">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>05 Okt 2025 08:45</td>
                                                    <td>Motor</td>
                                                    <td>F 5678 AB</td>
                                                    <td class="text-center">
                                                        <img src="https://images.unsplash.com/photo-1503376780353-7e6692767b70?w=100"
                                                             alt="Lampiran Motor" class="rounded border" width="100">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>05 Okt 2025 09:10</td>
                                                    <td>Mobil</td>
                                                    <td>D 9012 CD</td>
                                                    <td class="text-center">
                                                        <img src="https://images.unsplash.com/photo-1503736334956-4c8f8e92946d?w=100"
                                                             alt="Lampiran Mobil" class="rounded border" width="100">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>05 Okt 2025 09:35</td>
                                                    <td>Motor</td>
                                                    <td>B 7777 EF</td>
                                                    <td class="text-center">
                                                        <img src="https://images.unsplash.com/photo-1517336714731-489689fd1ca8?w=100"
                                                             alt="Lampiran Motor" class="rounded border" width="100">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>05 Okt 2025 10:00</td>
                                                    <td>Mobil</td>
                                                    <td>H 8888 GH</td>
                                                    <td class="text-center">
                                                        <img src="https://images.unsplash.com/photo-1483729558449-99ef09a8c325?w=100"
                                                             alt="Lampiran Mobil" class="rounded border" width="100">
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>

        $(document).ready(function () {
            loadLiveStreamingVideo();
        });

        function loadLiveStreamingVideo() {
            $("#loading2-LiveStreamingVideo").show();

            var nop = '@(nop)';
            var cctvId = '@(cctvId)';

            $.ajax({
                url: '@(Url.Action("LiveStreamingVideo"))',
                type: 'GET',
                data: { nop, cctvId  }, // kalau null berarti semua uptb
                success: function (result) {
                    $("#LiveStreamingVideo").html(result);
                },
                error: function () {
                    $("#LiveStreamingVideo").html("<div class='text-danger'>Gagal memuat data.</div>");
                },
                complete: function () {
                    $("#loading2-LiveStreamingVideo").hide();
                }
            });
        }
    </script>

    <script>
        async function startWebRTC(videoElementId, sourceUrl) {
            const videoElement = document.getElementById(videoElementId);
            if (!videoElement) {
                console.error(`Element dengan id '${videoElementId}' tidak ditemukan`);
                return;
            }

            const pc = new RTCPeerConnection({
                iceServers: [
                    { urls: ["stun:stun.l.google.com:19302"] } // optional
                ]
            });

            pc.ontrack = (event) => {
                console.log("Track diterima dari:", sourceUrl);
                videoElement.srcObject = event.streams[0];
            };

            pc.addTransceiver("video", { direction: "recvonly" });
            pc.addTransceiver("audio", { direction: "recvonly" });

            try {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                const res = await fetch(sourceUrl, {
                    method: "POST",
                    body: offer.sdp,
                    headers: { "Content-Type": "application/sdp" }
                });

                const answer = await res.text();
                await pc.setRemoteDescription({ type: "answer", sdp: answer });

                console.log(`✅ WebRTC connected: ${sourceUrl}`);
            } catch (err) {
                console.error(`❌ WebRTC error (${sourceUrl}):`, err);
            }
        }
    </script>

    <script>
        function updateTime() {
            const now = new Date();

            // Format waktu: HH:mm:ss | dd MMM yyyy (contoh: 21:45:12 | 05 Okt 2025)
            const formatted = now.toLocaleTimeString('id-ID', { hour12: false }) +
                ' | ' +
                now.toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' });

            document.getElementById('currentTime').textContent = formatted;
        }

        // Jalankan setiap detik
        updateTime();
        setInterval(updateTime, 1000);
    </script>

    <script>
        var options = {
            chart: {
                type: 'line',
                height: 300,
                toolbar: { show: false }
            },
            stroke: {
                curve: 'smooth',
                width: 3
            },
            markers: {
                size: 0 // tanpa dots
            },
            series: [
                {
                    name: "Mobil",
                    data: [12, 14, 18, 20, 22, 19, 25, 28, 30, 27, 20, 18]
                },
                {
                    name: "Motor",
                    data: [25, 30, 35, 40, 38, 36, 45, 50, 48, 46, 42, 40]
                }
            ],
            xaxis: {
                categories: ['07:00', '08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00', '17:00', '18:00'],
                title: { text: 'Waktu' }
            },
            yaxis: {
                title: { text: 'Jumlah Kendaraan' }
            },
            colors: ['#0d6efd', '#198754'],
            legend: {
                position: 'top'
            },
            grid: {
                borderColor: '#e7e7e7'
            }
        };

        var chart = new ApexCharts(document.querySelector("#grafikMonitoring"), options);
        chart.render();
    </script>
}