@using MonPDReborn.Models.AktivitasOP
@model RealisasiControlVM.Detail

@{
    var uptbList = Model.DataDetailList
        .SelectMany(x => x.Uptbs)
        .Select(x => new { x.UptbId, x.UptbNama })
        .Distinct()
        .OrderBy(x => x.UptbId)
        .ToList();
}

<div class="table-responsive">
    <table class="table table-bordered table-striped table-sm">
        <thead>
            <tr>
                <th rowspan="2" class="text-center align-middle">NO</th>
                <th rowspan="2" class="text-center align-middle">JENIS PAJAK</th>
                @foreach (var uptb in uptbList)
                {
                    <th colspan="3" class="text-center">@uptb.UptbNama</th>
                }
            </tr>
            <tr>
                @for (int i = 0; i < uptbList.Count; i++)
                {
                    <th class="text-center">Target</th>
                    <th class="text-center">Realisasi</th>
                    <th class="text-center">%</th>
                }
            </tr>
        </thead>
        <tbody>
            @{
                int seq = 1;
            }
            @foreach (var item in Model.DataDetailList.OrderBy(x => x.PajakId).ToList())
            {
                <tr>
                    <td>@(seq)</td>
                    <td>@(item.PajakNama)</td>
                    @foreach (var uptb in uptbList)
                    {
                        decimal target = item.Uptbs.Where(x => x.UptbId == uptb.UptbId).Sum(q => q.Target);
                        decimal realisasi = item.Uptbs.Where(x => x.UptbId == uptb.UptbId).Sum(q => q.Realisasi);
                        decimal persen = item.Uptbs.Where(x => x.UptbId == uptb.UptbId).Sum(q => q.Persen);

                        <td class="text-end">@target.ToString("#,##0")</td>
                        <td class="text-end">@realisasi.ToString("#,##0")</td>
                        <td class="text-end">@persen.ToString("n2")%</td>
                    }
                </tr>

                seq++;
            }
        </tbody>
        <tfoot>
            <tr>
                <th colspan="2" class="text-center">TOTAL</th>
                @{
                    var totalUptbs = Model.DataDetailList.SelectMany(x => x.Uptbs).ToList();
                }
                @foreach (var item in uptbList)
                {
                    decimal totalTarget = totalUptbs.Where(x => x.UptbId == item.UptbId).Sum(x => x.Target);
                    decimal totalRealisasi = totalUptbs.Where(x => x.UptbId == item.UptbId).Sum(x => x.Realisasi);
                    decimal totalPersen = totalRealisasi > 0 ? (totalRealisasi / totalTarget) * 100 : 0;

                    <th class="text-end">@(totalTarget.ToString("#,##0"))</th>
                    <th class="text-end">@(totalRealisasi.ToString("#,##0"))</th>
                    <th class="text-end">@(totalPersen.ToString("n2"))%</th>
                }    
            </tr>
        </tfoot>
    </table>

</div>
